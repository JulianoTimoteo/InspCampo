<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ†Ô∏èü™õ InspCampo üõ†Ô∏èü™õ</title>
    <!-- Tailwind CSS para estiliza√ß√£o (CDN para ambiente de desenvolvimento/Canvas) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome para √≠cones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <!-- jsPDF para exporta√ß√£o de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- html2canvas para captura de tela para PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- SheetJS (xlsx) para exporta√ß√£o de XLSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <!-- √çcone do aplicativo (Favicon) -->
    <link rel="icon" href="https://usinapitangueiras.com.br/wp-content/uploads/2020/10/cropped-favicon-32x32.png" type="image/png">
    <!-- √çcone para atalho (PWA icon) -->
    <link rel="apple-touch-icon" href="https://usinapitangueiras.com.br/wp-content/uploads/2022/04/usina-pitangueiras-logo.png">
    <style>
        /* Define a fonte Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Estilos para os bot√µes de abas */
        .tab-button {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        .tab-button:hover {
            border-bottom-color: #d1d5db;
        }
        .tab-button.active {
            border-bottom-color: #2563eb;
            color: #2563eb;
            font-weight: 600;
        }
        /* Estilos do Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        /* Estilos para o toast de notifica√ß√£o */
        #notification-toast {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #10b981;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1-px rgba(0, 0, 0, 0.06);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
            z-index: 2000;
        }
        #notification-toast.show {
            opacity: 1;
            visibility: visible;
        }
        /* Estilos para o card principal */
        .main-card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            margin-top: 1.5rem;
        }
        /* Estilos para os bot√µes de tags */
        .tag-button {
            transition: all 0.2s ease-in-out;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            cursor: pointer;
            border: 1px solid transparent;
            font-weight: 500;
        }
        .tag-button.active {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
        }
        .tag-button:not(.active):hover {
            background-color: #e5e7eb;
        }
        /* Estilo para impress√£o */
        @media print {
            body > *:not(#report-modal):not(.print-only) {
                display: none;
            }
            #report-modal {
                display: block !important;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                background-color: white;
                margin: 0;
                padding: 0;
                box-shadow: none;
            }
            #report-modal .modal-content {
                width: 100%;
                max-width: 100%;
                padding: 1rem;
            }
            #report-modal .print\:hidden {
                display: none;
            }
        }
        #user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #ccc;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            color: #fff;
            cursor: pointer;
            overflow: hidden; /* Garante que a imagem n√£o vaze */
        }
        #user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Garante que a imagem preencha o cont√™iner sem ser esticada */
        }

        /* Anima√ß√£o para a logo na tela de login */
        @keyframes fadeAndSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-slide-in {
            animation: fadeAndSlideIn 0.8s ease-out forwards;
        }
    </style>
</head>
<body class="font-inter">
    <!-- Tela de Login -->
    <div id="login-screen" class="flex flex-col items-center justify-center min-h-screen p-4">
        <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg w-full max-w-md md:min-h-[500px] flex flex-col justify-center items-center">
            <!-- Logo da Usina Pitangueiras -->
            <img id="login-logo" src="https://usinapitangueiras.com.br/wp-content/uploads/2020/04/usina-pitangueiras-logo.png" alt="Logo Usina Pitangueiras" class="w-2/3 max-w-[200px] h-auto mx-auto mb-6 animate-fade-slide-in">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Login</h1>
            <form id="login-form" class="space-y-4 w-full">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">Usu√°rio</label>
                    <input type="text" id="username" name="username" class="mt-1 block w-full rounded-md border border-gray-400 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" required>
                </div>
                <div class="relative">
                    <label for="password" class="block text-sm font-medium text-gray-700">Senha</label>
                    <input type="password" id="password" name="password" class="mt-1 block w-full rounded-md border border-gray-400 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" required minlength="8" pattern="^(?=.*[a-zA-Z])(?=.*[0-9]).{8,}$">
                    <button type="button" id="toggle-password" class="absolute inset-y-0 right-0 top-6 px-3 flex items-center text-gray-500">
                        <i class="fas fa-eye"></i>
                    </button>
                    <p id="caps-lock-warning" class="text-sm text-red-500 mt-1 hidden">Caps Lock est√° ativado!</p>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="remember-me" class="rounded text-blue-600 focus:ring-blue-500">
                    <label for="remember-me" class="ml-2 block text-sm text-gray-900">Salvar usu√°rio e senha</label>
                </div>
                <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-full shadow-lg transition-colors">
                    Entrar
                </button>
            </form>
        </div>
    </div>

    <!-- Interface Principal do Aplicativo -->
    <div id="main-app" class="container mx-auto p-6 md:p-8 hidden">
        <div class="flex flex-col md:flex-row justify-between items-center mb-8">
            <!-- T√≠tulo e Logo ajustados para responsividade -->
            <div class="flex flex-col items-center md:items-start w-full md:w-auto mb-4 md:mb-0">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800 text-center md:text-left mb-2">Sistema de Checklists</h1>
                <img src="https://usinapitangueiras.com.br/wp-content/uploads/2020/04/usina-pitangueiras-logo.png" alt="Logo Usina Pitangueiras" class="max-w-xs md:max-w-sm lg:max-w-md h-auto mx-auto md:mx-0" style="width: 100%; max-width: 250px;">
            </div>
            <div class="flex items-center space-x-4 mt-4 md:mt-0">
                <div id="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <span id="user-info" class="text-gray-600"></span>
                <button id="change-password-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-full shadow-lg transition-colors">
                    üîíSenhaüîì
                </button>
                <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-full shadow-lg transition-colors">
                    Sair
                </button>
            </div>
        </div>

        <!-- Abas -->
        <div class="flex flex-wrap justify-center space-x-2 md:space-x-4 mb-8 border-b border-gray-200">
            <button id="aplicador-tab" class="tab-button pb-2 text-gray-500 hidden">Aplicador</button>
            <button id="lider-tab" class="tab-button pb-2 text-gray-500 hidden">L√≠der</button>
            <button id="pcma-tab" class="tab-button pb-2 text-gray-500 hidden">PCMA</button>
            <button id="realizados-tab" class="tab-button pb-2 text-gray-500 hidden">Realizados</button>
            <button id="novos-tab" class="tab-button pb-2 text-gray-500 hidden">Novo/Editar</button>
            <button id="cadastro-tab" class="tab-button pb-2 text-gray-500 hidden">Cadastro</button>
        </div>

        <!-- Conte√∫do das Abas -->
        <div id="aplicador-content" class="tab-content hidden">
            <div class="main-card p-4 sm:p-6 md:p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Checklists Dispon√≠veis</h2>
                <div id="tag-cloud-aplicador" class="flex flex-wrap gap-2 mb-6"></div>
                <div id="aplicador-form-container" class="mt-8 hidden">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Aplicar Checklist: <span id="aplicador-checklist-title"></span></h3>
                    <form id="aplicador-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="frota" class="block text-sm font-medium text-gray-700">Frota (M√°x 7 d√≠gitos)</label>
                                <input type="text" id="frota" name="frota" class="mt-1 block w-full rounded-md border border-gray-400 shadow-sm" required minlength="1" maxlength="7" pattern="[0-9]{1,7}">
                            </div>
                            <div>
                                <label for="os" class="block text-sm font-medium text-gray-700">N¬∫ OS (M√°x 7 d√≠gitos)</label>
                                <input type="text" id="os" name="os" class="mt-1 block w-full rounded-md border border-gray-400 shadow-sm" required minlength="1" maxlength="7" pattern="[0-9]{1,7}">
                            </div>
                            <div>
                                <label for="aplicador-name" class="block text-sm font-medium text-gray-700">Aplicador</label>
                                <input type="text" id="aplicador-name" name="aplicador-name" class="mt-1 block w-full rounded-md border border-gray-400 shadow-sm bg-gray-100" readonly>
                            </div>
                            <div>
                                <label for="mecanico-name" class="block text-sm font-medium text-gray-700">Mec√¢nico</label>
                                <input type="text" id="mecanico-name" name="mecanico-name" class="mt-1 block w-full rounded-md border border-gray-400 shadow-sm">
                            </div>
                            <div>
                                <label for="start-time" class="block text-sm font-medium text-gray-700">Hora Inicial</label>
                                <input type="text" id="start-time" name="start-time" class="mt-1 block w-full rounded-md border border-gray-400 shadow-sm bg-gray-100" readonly>
                            </div>
                            <div>
                                <label for="end-time" class="block text-sm font-medium text-gray-700">Hora Final</label>
                                <input type="text" id="end-time" name="end-time" class="mt-1 block w-full rounded-md border border-gray-400 shadow-sm bg-gray-100" readonly>
                            </div>
                        </div>
                        <div id="aplicador-sections-container"></div>
                        <div class="flex justify-end pt-4">
                            <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-full shadow-lg transition-colors">
                                Salvar Respostas
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div id="lider-content" class="tab-content hidden">
            <div class="main-card p-4 sm:p-6 md:p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Checklists Pendentes para L√≠der</h2>
                <div id="lider-checklists-container"></div>
            </div>
        </div>

        <div id="pcma-content" class="tab-content hidden">
            <div class="main-card p-4 sm:p-6 md:p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Checklists Pendentes para PCMA</h2>
                <div id="pcma-checklists-container"></div>
            </div>
        </div>

        <div id="realizados-content" class="tab-content hidden">
            <div class="main-card p-4 sm:p-6 md:p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Checklists Realizados</h2>
                <div id="realizados-list-container"></div>
                <div id="realizados-pagination" class="flex justify-center space-x-2 mt-4"></div>
            </div>
        </div>

        <div id="novos-content" class="tab-content hidden">
            <div class="main-card p-4 sm:p-6 md:p-8">
                <div class="flex items-center justify-between mb-6 flex-wrap gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <span id="novos-title">Novo Checklist</span>
                    </h2>
                    <div class="flex space-x-2">
                        <button id="delete-selected-checklist-btn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-full shadow-lg transition-colors hidden">
                            <i class="fas fa-trash-alt mr-2"></i>Excluir
                        </button>
                        <button id="save-new-checklist-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-full shadow-lg transition-colors">
                            <i class="fas fa-save mr-2"></i>Salvar
                        </button>
                    </div>
                </div>
                <div id="tag-cloud-novos" class="flex flex-wrap gap-2 mb-6"></div>
                <form id="novos-checklist-form" class="space-y-4 mt-8">
                    <div>
                        <label for="checklist-title" class="block text-sm font-medium text-gray-700">T√≠tulo do Checklist</label>
                        <input type="text" id="checklist-title" name="checklist-title" placeholder="Ex: Checklist de Manuten√ß√£o" class="mt-1 block w-full rounded-md border border-gray-400 shadow-sm" required>
                    </div>
                    <div id="sections-container"></div>
                    <div class="flex justify-end pt-4">
                        <button type="button" id="add-section-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-full shadow-sm">
                            <i class="fas fa-plus-circle mr-2"></i>Adicionar Se√ß√£o
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="cadastro-content" class="tab-content hidden">
            <div class="main-card p-4 sm:p-6 md:p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Gerenciamento de Usu√°rios</h2>
                <div class="mb-4">
                    <label for="user-search" class="block text-sm font-medium text-gray-700">Buscar Usu√°rio</label>
                    <input type="text" id="user-search" placeholder="Buscar por nome ou usu√°rio..." class="mt-1 block w-full rounded-md border border-gray-400 shadow-sm">
                </div>
                <div class="mb-4 flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4">
                    <button id="import-xlsx-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-full shadow-lg transition-colors w-full sm:w-auto">
                        <i class="fas fa-file-excel mr-2"></i>Importar XLSX
                    </button>
                    <input type="file" id="upload-xlsx-input" accept=".xlsx" class="hidden">
                    <i class="fas fa-question-circle text-gray-500 cursor-help" title="Formato esperado: nome, usuario, senha, nivelAcesso, id"></i>

                    <button id="import-csv-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-full shadow-lg transition-colors w-full sm:w-auto">
                        <i class="fas fa-file-csv mr-2"></i>Importar CSV
                    </button>
                    <input type="file" id="upload-csv-input" accept=".csv" class="hidden">
                    <i class="fas fa-question-circle text-gray-500 cursor-help" title="Formato esperado: nome, usuario, senha, nivelAcesso, id"></i>
                </div>
                <div class="mb-4">
                    <h3 class="text-xl font-bold mb-2">Novo Usu√°rio</h3>
                    <form id="add-user-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="new-user-name" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                                <input type="text" id="new-user-name" name="new-user-name" class="mt-1 block w-full rounded-md border border-gray-400 shadow-sm" required>
                            </div>
                            <div>
                                <label for="new-user-id" class="block text-sm font-medium text-gray-700">ID USINA</label>
                                <input type="text" id="new-user-id" name="new-user-id" class="mt-1 block w-full rounded-md border border-gray-400 shadow-sm" required>
                            </div>
                            <div>
                                <label for="new-user-username" class="block text-sm font-medium text-gray-700">Usu√°rio (Login)</label>
                                <input type="text" id="new-user-username" name="new-user-username" class="mt-1 block w-full rounded-md border border-gray-400 shadow-sm" required>
                            </div>
                            <div class="relative">
                                <label for="new-user-password" class="block text-sm font-medium text-gray-700">Senha</label>
                                <input type="password" id="new-user-password" name="new-user-password" class="mt-1 block w-full rounded-md border border-gray-400 shadow-sm" required minlength="8" pattern="^(?=.*[a-zA-Z])(?=.*[0-9]).{8,}$">
                                <button type="button" id="toggle-new-user-password" class="absolute inset-y-0 right-0 top-6 px-3 flex items-center text-gray-500">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div id="access-level-container">
                                <label for="new-user-level" class="block text-sm font-medium text-gray-700">N√≠vel de Acesso</label>
                                <select id="new-user-level" name="new-user-level" class="mt-1 block w-full rounded-md border border-gray-400 shadow-sm">
                                    <option value="aplicador">Aplicador</option>
                                    <option value="lider">L√≠der</option>
                                    <option value="pcma">PCMA</option>
                                    <option value="master">Master</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-full shadow-lg transition-colors">
                            <i class="fas fa-user-plus mr-2"></i>Adicionar Usu√°rio
                        </button>
                    </form>
                </div>

                <div id="user-list-container" class="mt-8">
                    <h3 class="text-xl font-bold mb-2">Usu√°rios Cadastrados</h3>
                    <div id="user-list" class="grid grid-cols-1 gap-4"></div> <!-- Alterado para grid -->
                    <div id="user-pagination" class="flex justify-center space-x-2 mt-4"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Mensagem -->
    <div id="message-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4"></h3>
            <p id="modal-body" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end">
                <button id="modal-close-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-full">Ok</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <h3 id="confirm-modal-title" class="text-xl font-bold text-gray-800 mb-4"></h3>
            <p id="confirm-modal-body" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end space-x-4">
                <button id="confirm-modal-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-full">Cancelar</button>
                <button id="confirm-modal-confirm-btn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-full">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Relat√≥rio -->
    <div id="report-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Relat√≥rio do Checklist</h3>
            <div id="report-content" class="prose max-w-none"></div>
            <div class="flex justify-end space-x-4 mt-6 print:hidden">
                <button id="export-pdf-btn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-full"><i class="fas fa-file-pdf mr-2"></i>Exportar PDF</button>
                <button id="export-xlsx-btn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-full"><i class="fas fa-file-excel mr-2"></i>Exportar XLSX</button>
                <button id="share-report-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-full ml-4"><i class="fas fa-share-alt mr-2"></i>Compartilhar</button>
                <button id="report-modal-close-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-full">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Sele√ß√£o de Avatar -->
    <div id="avatar-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Alterar Avatar</h3>
            <div class="flex flex-col space-y-4">
                <button id="take-photo-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-full shadow-lg transition-colors">
                    <i class="fas fa-camera mr-2"></i>Tirar Foto
                </button>
                <input type="file" id="upload-photo-input" accept="image/*" class="hidden">
                <button id="choose-photo-btn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-full shadow-lg transition-colors">
                    <i class="fas fa-upload mr-2"></i>Escolher da Galeria
                </button>
                <button id="avatar-modal-close-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-full">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Alterar Senha (separado da aba Cadastro) -->
    <div id="change-password-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Alterar Senha</h3>
            <form id="change-password-modal-form" class="space-y-4">
                <div class="relative">
                    <label for="current-password-modal" class="block text-sm font-medium text-gray-700">Senha Atual</label>
                    <input type="password" id="current-password-modal" name="current-password-modal" class="mt-1 block w-full rounded-md border border-gray-400 shadow-sm" required>
                    <button type="button" id="toggle-current-password-modal" class="absolute inset-y-0 right-0 top-6 px-3 flex items-center text-gray-500">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div class="relative">
                    <label for="new-password-modal" class="block text-sm font-medium text-gray-700">Nova Senha (min. 8 d√≠gitos, com letras e n√∫meros)</label>
                    <input type="password" id="new-password-modal" name="new-password-modal" class="mt-1 block w-full rounded-md border border-gray-400 shadow-sm" required minlength="8" pattern="^(?=.*[a-zA-Z])(?=.*[0-9]).{8,}$">
                    <button type="button" id="toggle-new-password-modal" class="absolute inset-y-0 right-0 top-6 px-3 flex items-center text-gray-500">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div class="relative">
                    <label for="confirm-new-password-modal" class="block text-sm font-medium text-gray-700">Confirmar Nova Senha</label>
                    <input type="password" id="confirm-new-password-modal" name="confirm-new-password-modal" class="mt-1 block w-full rounded-md border border-gray-400 shadow-sm" required>
                    <button type="button" id="toggle-confirm-new-password-modal" class="absolute inset-y-0 right-0 top-6 px-3 flex items-center text-gray-500">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="change-password-modal-cancel-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-full">Cancelar</button>
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-full shadow-lg transition-colors">
                        Alterar Senha
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast de Notifica√ß√£o -->
    <div id="notification-toast"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Vari√°veis globais para Firebase e estado da aplica√ß√£o
        let app, db, auth;
        // Definimos currentUser com uma estrutura que inclui appDocId e actualFirebaseAuthUid
        let currentUser = {
            appDocId: null, // O ID do documento do usu√°rio no Firestore (UUID gerado pelo app)
            actualFirebaseAuthUid: null, // O UID do Firebase Auth da sess√£o atual
            nome: null,
            usuario: null,
            nivel: null,
            id: null, // ID USINA
            ativo: null,
        };
        const environmentAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // Configura√ß√£o do Firebase: prioriza a configura√ß√£o do ambiente, com fallback para a configura√ß√£o fornecida.
        const firebaseConfig = typeof __firebase_config !== 'undefined' && Object.keys(JSON.parse(__firebase_config)).length > 0
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "AIzaSyDtmdNMWILnWlzAeR2sRYM1SBJRE8FN4sg",
                authDomain: "inspcampo-2f988.firebaseapp.com",
                projectId: "inspcampo-2f988",
                storageBucket: "inspcampo-2f988.appspot.com",
                messagingSenderId: "1046570896752",
                appId: "1:1046570896752:web:c1d8edd8660fcbfb4a53b5",
                measurementId: "G-1QZJ41R49Z"
              };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Cole√ß√µes agora sem o prefixo 'artifacts/{appId}' para corresponder √†s regras
        const COLLECTIONS = {
            USERS: "users",
            DYNAMIC_CHECKLISTS: "dynamic_checklists",
            APPLIED_CHECKLISTS: "applied_checklists",
            CALLS: "calls",
            FRONTS: "fronts",
            LOGIN_REQUESTS: "loginRequests"
        };
        const PAGINATION_LIMIT = 5; // Limite de pagina√ß√£o para ambas as guias

        // Global variables to store unsubscribe functions for onSnapshot listeners
        let unsubscribeChecklists = null;
        let unsubscribePendingLider = null;
        let unsubscribePendingPcma = null;
        let unsubscribeAppliedChecklists = null;
        let unsubscribeUsers = null;

        // --- Fun√ß√µes de UI ---

        // Exibe um modal de mensagem
        const showModal = (title, message) => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').textContent = message;
            document.getElementById('message-modal').style.display = 'flex';
        };

        // Exibe um modal de confirma√ß√£o
        const showConfirmModal = (title, message, onConfirm) => {
            document.getElementById('confirm-modal-title').textContent = title;
            document.getElementById('confirm-modal-body').textContent = message;
            document.getElementById('confirm-modal-confirm-btn').onclick = () => {
                onConfirm();
                hideModal();
            };
            document.getElementById('confirm-modal').style.display = 'flex';
        };

        // Esconde todos os modals
        const hideModal = () => {
            document.getElementById('message-modal').style.display = 'none';
            document.getElementById('confirm-modal').style.display = 'none';
            document.getElementById('report-modal').style.display = 'none';
            document.getElementById('avatar-modal').style.display = 'none';
            document.getElementById('change-password-modal').style.display = 'none'; // Esconde o modal de alterar senha
        };

        // Altera a aba ativa
        const switchTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active', 'text-blue-600');
                button.classList.add('text-gray-500');
            });

            const contentElement = document.getElementById(`${tabName}-content`);
            if (contentElement) {
                contentElement.classList.remove('hidden');
            }
            const tabButton = document.getElementById(`${tabName}-tab`);
            if (tabButton) {
                tabButton.classList.add('active', 'text-blue-600');
                tabButton.classList.remove('text-gray-500');
            }

            // L√≥gica espec√≠fica para cada aba
            if (tabName === 'novos') {
                document.getElementById('novos-title').textContent = 'Novo Checklist';
                document.getElementById('delete-selected-checklist-btn').classList.add('hidden');
                document.getElementById('novos-checklist-form').setAttribute('data-checklist-id', '');
                renderChecklistFormNovos();
            }
            if (tabName === 'realizados') {
                renderRealizadosList(1);
            }
            if (tabName === 'cadastro') {
                renderUserList(1); // Renderiza a primeira p√°gina de usu√°rios
            }
        };

        // Exibe um toast de notifica√ß√£o
        const showToast = (message, type = 'success') => {
            const toast = document.getElementById('notification-toast');
            toast.textContent = message;
            if (type === 'success') {
                toast.style.backgroundColor = '#10b981';
            } else if (type === 'error') {
                toast.style.backgroundColor = '#ef4444';
            }
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        };
        
        // Fun√ß√£o para mostrar ou esconder o bot√£o de toggle de senha
        const togglePasswordVisibility = (inputSelector, buttonSelector) => {
            const passwordInput = document.querySelector(inputSelector);
            const toggleButton = document.querySelector(buttonSelector);
            if (passwordInput && toggleButton) {
                toggleButton.addEventListener('click', () => {
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    toggleButton.querySelector('i').classList.toggle('fa-eye');
                    toggleButton.querySelector('i').classList.toggle('fa-eye-slash');
                });
            }
        };

        // --- Fun√ß√µes de Utilit√°rio ---

        // Utility function for exponential backoff retry
        const retryWithExponentialBackoff = async (func, retries = 3, delay = 1000) => {
            for (let i = 0; i < retries; i++) {
                try {
                    return await func();
                } catch (error) {
                    // Log detalhado para erros de rede
                    if (error.code === 'unavailable' || error.code === 'internal' || error.code === 'resource-exhausted' || error.code === 'cancelled') {
                        console.warn(`Tentativa de re-conex√£o ${i + 1}/${retries} para erro de rede: ${error.message}. Tentando novamente em ${delay / 1000}s...`);
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; // Aumento exponencial
                    } else {
                        throw error; // Re-lan√ßa outros tipos de erros imediatamente
                    }
                }
            }
            throw new Error('N√∫mero m√°ximo de tentativas excedido para a opera√ß√£o.');
        };

        // Check for online/offline status
        const checkOnlineStatus = () => {
            if (!navigator.onLine) {
                showToast('Voc√™ est√° offline. Algumas opera√ß√µes podem n√£o funcionar.', 'error');
                console.warn('Aplicativo est√° offline. Opera√ß√µes do Firestore podem falhar.');
            } else {
                showToast('Voc√™ est√° online novamente!', 'success');
                console.log('Aplicativo est√° online.');
            }
        };


        // --- Firebase e L√≥gica de Autentica√ß√£o ---

        // Inicializa o Firebase
        const initFirebase = async () => {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing. Please provide it.");
                showModal('Erro de Inicializa√ß√£o', 'A configura√ß√£o do Firebase est√° faltando. N√£o foi poss√≠vel iniciar o aplicativo.');
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Ouve as mudan√ßas de estado da autentica√ß√£o do Firebase Auth
                onAuthStateChanged(auth, async (user) => {
                    console.log("[onAuthStateChanged] Triggered. Firebase Auth User UID:", user ? user.uid : "null", "Is Anonymous:", user ? user.isAnonymous : "N/A");

                    if (user) { // Se h√° um usu√°rio autenticado pelo Firebase Auth (mesmo que an√¥nimo)
                        // Se o token inicial √© fornecido (ambiente Canvas), tente fazer login com ele primeiro
                        if (initialAuthToken) {
                            try {
                                const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                                console.log("[onAuthStateChanged] Login com token personalizado bem-sucedido:", userCredential.user.uid);
                                // A partir daqui, o onAuthStateChanged ser√° chamado novamente com o usu√°rio autenticado.
                                // N√£o fa√ßa nada mais aqui para evitar loops ou comportamento inesperado.
                                return; 
                            } catch (tokenError) {
                                console.error("[onAuthStateChanged] Erro ao fazer login com token personalizado:", tokenError);
                                // Se o token falhar, continue com o fluxo normal (an√¥nimo ou login).
                            }
                        }

                        // Tenta encontrar um perfil de usu√°rio do aplicativo associado ao UID do Firebase Auth
                        // Agora busca pelo campo 'actualFirebaseAuthUid' que aponta para o UID do Firebase Auth
                        const q = query(collection(db, COLLECTIONS.USERS), where("actualFirebaseAuthUid", "==", user.uid));
                        console.log(`[onAuthStateChanged] Buscando perfil do app vinculado ao Firebase Auth UID: ${user.uid}`);
                        const querySnapshot = await retryWithExponentialBackoff(() => getDocs(q));

                        if (!querySnapshot.empty) {
                            // Encontrou um perfil de usu√°rio do aplicativo. Prioriza o primeiro encontrado se houver m√∫ltiplos (n√£o deveria)
                            const userDoc = querySnapshot.docs[0];
                            currentUser = { 
                                appDocId: userDoc.id, // O ID do documento no Firestore (UUID gerado pelo app)
                                actualFirebaseAuthUid: user.uid, // O UID do Firebase Auth da sess√£o atual
                                ...userDoc.data() 
                            };
                            console.log("[onAuthStateChanged] Perfil de usu√°rio do aplicativo encontrado e vinculado:", currentUser.appDocId);
                            handlePostLogin();
                        } else {
                            // Nenhum perfil de usu√°rio do aplicativo vinculado a este UID do Firebase Auth.
                            // Isso pode acontecer para novos usu√°rios an√¥nimos ou se o usu√°rio ainda n√£o logou com username/password.
                            console.log("[onAuthStateChanged] Nenhum perfil de usu√°rio do aplicativo vinculado a este Firebase Auth UID. Exibindo tela de login.");
                            showLoginScreen();
                        }
                    } else {
                        // Nenhum usu√°rio do Firebase Auth (ex: ap√≥s logout ou carga inicial sem pr√©-autentica√ß√£o)
                        try {
                            // Tenta login an√¥nimo para estabelecer uma sess√£o do Firebase Auth.
                            // Isso garantir√° que `onAuthStateChanged` seja acionado novamente com um `user` (an√¥nimo).
                            await signInAnonymously(auth);
                            console.log("[onAuthStateChanged] Nenhum usu√°rio Firebase Auth. Login an√¥nimo realizado.");
                        } catch (anonError) {
                            console.warn("[onAuthStateChanged] Erro ao tentar login an√¥nimo ao iniciar sem usu√°rio:", anonError);
                            showModal('Erro de Autentica√ß√£o', 'N√£o foi poss√≠vel iniciar a sess√£o an√¥nima. Tente novamente.');
                        }
                        showLoginScreen(); // Sempre mostra a tela de login se n√£o houver um usu√°rio logado
                    }
                });

            } catch (error) {
                console.error("Erro ao inicializar Firebase ou autenticar:", error);
                showModal('Erro', 'N√£o foi poss√≠vel conectar ao sistema. Por favor, tente novamente.');
            }
        };


        // L√≥gica de login
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const usernameInput = document.getElementById('username').value.trim();
            const passwordInput = document.getElementById('password').value.trim();
            const rememberMe = document.getElementById('remember-me').checked;

            console.log(`[Login Submit] Tentativa de login para usu√°rio: ${usernameInput}.`);

            try {
                // 1. Encontra o perfil de usu√°rio do aplicativo pelo username e senha
                // A busca agora √© estritamente por 'usuario' e 'senha' para encontrar o documento de perfil permanente.
                const q = query(
                    collection(db, COLLECTIONS.USERS), 
                    where("usuario", "==", usernameInput),
                    where("senha", "==", passwordInput)
                );
                console.log(`[Login Submit] Consultando Firestore por usu√°rio: ${usernameInput}`);
                const querySnapshot = await retryWithExponentialBackoff(() => getDocs(q));
                
                let foundUserDoc = null;

                if (querySnapshot.empty) {
                    console.warn(`[Login Submit] Usu√°rio ou senha incorretos para: ${usernameInput}.`);
                    showModal('Erro de Login', 'Usu√°rio ou senha incorretos.');
                    return;
                }

                // Assume que `usuario` √© √∫nico e pegamos o primeiro resultado v√°lido
                foundUserDoc = querySnapshot.docs[0];
                const appUserId = foundUserDoc.id; // Este √© o ID est√°vel do documento do usu√°rio no Firestore (UUID ou outro)
                const userDataFromFirestore = foundUserDoc.data();

                // 2. Garante que haja um Firebase Auth UID para a sess√£o atual (pode ser an√¥nimo)
                let firebaseAuthUser = auth.currentUser; 
                if (!firebaseAuthUser || !firebaseAuthUser.uid) {
                    console.warn("[Login Submit] Nenhuma sess√£o ativa do Firebase Auth. Tentando login an√¥nimo de fallback.");
                    try {
                        const anonUserCredential = await signInAnonymously(auth);
                        firebaseAuthUser = anonUserCredential.user;
                        console.log("[Login Submit] Fallback: Login an√¥nimo realizado para obter Firebase Auth UID:", firebaseAuthUser.uid);
                    } catch (anonError) {
                        console.error("[Login Submit] Erro no fallback de login an√¥nimo:", anonError);
                        showModal('Erro de Autentica√ß√£o', 'N√£o foi poss√≠vel iniciar a sess√£o do Firebase. Tente novamente.');
                        return;
                    }
                }
                if (!firebaseAuthUser || !firebaseAuthUser.uid) { 
                     console.error("[Login Submit] Erro cr√≠tico: firebaseAuthUser √© nulo ou n√£o tem UID ap√≥s todas as tentativas.");
                     showModal('Erro Interno', 'Falha cr√≠tica na autentica√ß√£o. Recarregue a p√°gina.');
                     return;
                }

                // 3. Vincula o UID da sess√£o Firebase Auth ao perfil de usu√°rio do aplicativo
                const currentFirebaseAuthUid = firebaseAuthUser.uid;
                const userDocRef = doc(db, COLLECTIONS.USERS, appUserId); // Referencia o documento permanente

                // Log dos UIDs para depura√ß√£o antes da atualiza√ß√£o
                console.log(`[Login Submit] UID da sess√£o Firebase Auth: ${currentFirebaseAuthUid}`);
                console.log(`[Login Submit] ID do documento do usu√°rio (appDocId): ${appUserId}`);
                console.log(`[Login Submit] Atualizando 'actualFirebaseAuthUid' do documento ${appUserId} para ${currentFirebaseAuthUid}.`);

                // Atualiza o perfil de usu√°rio com o UID da sess√£o atual do Firebase Auth
                // Esta opera√ß√£o requer que as regras de seguran√ßa permitam que o user.uid atualize o campo actualFirebaseAuthUid.
                await retryWithExponentialBackoff(() => updateDoc(userDocRef, { actualFirebaseAuthUid: currentFirebaseAuthUid }));
                
                console.log(`[Login Submit] Perfil de usu√°rio ${appUserId} vinculado ao Firebase Auth UID: ${currentFirebaseAuthUid} com sucesso.`);

                // 4. Atualiza o objeto currentUser global
                currentUser = {
                    appDocId: appUserId, // O ID est√°vel do documento do Firestore
                    actualFirebaseAuthUid: currentFirebaseAuthUid, // O UID da sess√£o Firebase Auth atual
                    ...userDataFromFirestore // Copia todos os outros dados do usu√°rio
                };
                console.log("[Login Submit] Login bem-sucedido. Usu√°rio do aplicativo atualizado:", currentUser);

                if (rememberMe) {
                    localStorage.setItem('lastUser', usernameInput);
                } else {
                    localStorage.removeItem('lastUser');
                }
                
                handlePostLogin();
                
            } catch (error) {
                console.error("[Login Submit] Erro durante o login:", error);
                // Exibe uma mensagem mais espec√≠fica se for um erro de permiss√£o
                if (error.code === 'permission-denied') {
                    showModal('Erro de Permiss√£o', 'N√£o foi poss√≠vel vincular sua sess√£o. Verifique as regras de seguran√ßa do Firebase ou entre em contato com o suporte.');
                } else {
                    showModal('Erro de Login', 'Ocorreu um erro inesperado. Tente novamente.');
                }
            }
        });

        // Mostra a tela de login
        const showLoginScreen = () => {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
            const lastUser = localStorage.getItem('lastUser');
            if (lastUser) {
                document.getElementById('username').value = lastUser;
            }
            // Resetar a anima√ß√£o para que ela ocorra novamente ao exibir a tela de login
            const loginLogo = document.getElementById('login-logo');
            if (loginLogo) {
                loginLogo.classList.remove('animate-fade-slide-in');
                void loginLogo.offsetWidth; // Trigger reflow
                loginLogo.classList.add('animate-fade-slide-in');
            }
        };

        // L√≥gica ap√≥s o login bem-sucedido
        const handlePostLogin = async () => {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            showToast(`Bem-vindo(a), ${currentUser.nome}!`, 'success');
            // Exibe o ID USINA e o ID do documento do Firestore
            document.getElementById('user-info').textContent = `${currentUser.nome} (ID USINA: ${currentUser.id}) - Doc ID: ${currentUser.appDocId}`;
            setupTabs(currentUser.nivel);
            const savedAvatar = localStorage.getItem(`avatar-${currentUser.appDocId}`); // Usa appDocId para avatar
            if (savedAvatar) {
                const avatarImg = document.createElement('img');
                avatarImg.src = savedAvatar;
                const userAvatarDiv = document.getElementById('user-avatar');
                userAvatarDiv.innerHTML = '';
                userAvatarDiv.appendChild(avatarImg);
            }
            // Force refresh of user list if master, as consolidation might have happened
            if (currentUser.nivel === 'master') {
                console.log("[handlePostLogin] Usu√°rio √© master, for√ßando atualiza√ß√£o da lista de usu√°rios.");
                renderUserList(1);
            }

            if (currentUser.nivel === 'aplicador') switchTab('aplicador');
            else if (currentUser.nivel === 'lider') switchTab('lider');
            else if (currentUser.nivel === 'pcma') switchTab('pcma');
            else if (currentUser.nivel === 'master') switchTab('aplicador');
        };

        // Configura as abas vis√≠veis de acordo com o n√≠vel de acesso
        const setupTabs = (nivel) => {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.add('hidden'));

            const allTabs = {
                'master': ['aplicador', 'lider', 'pcma', 'realizados', 'novos', 'cadastro'],
                'pcma': ['pcma', 'realizados', 'novos'], 
                'lider': ['lider', 'realizados'],
                'aplicador': ['aplicador', 'realizados']
            };

            const visibleTabs = allTabs[nivel] || [];
            visibleTabs.forEach(tab => {
                const btn = document.getElementById(`${tab}-tab`);
                if (btn) btn.classList.remove('hidden');
            });

            // Desinscreve todos os listeners antigos para evitar duplica√ß√µes e vazamentos de mem√≥ria
            console.log("[setupTabs] Desinscrevendo listeners antigos...");
            if (unsubscribeChecklists) { unsubscribeChecklists(); unsubscribeChecklists = null; }
            if (unsubscribePendingLider) { unsubscribePendingLider(); unsubscribePendingLider = null; }
            if (unsubscribePendingPcma) { unsubscribePendingPcma(); unsubscribePendingPcma = null; }
            if (unsubscribeAppliedChecklists) { unsubscribeAppliedChecklists = null; }
            if (unsubscribeUsers) { unsubscribeUsers(); unsubscribeUsers = null; }
            console.log("[setupTabs] Listeners antigos desinscritos.");

            // S√≥ inicia os listeners de dados se o usu√°rio estiver autenticado (ou seja, currentUser.appDocId est√° preenchido)
            if (currentUser && currentUser.appDocId) {
                console.log("[setupTabs] Usu√°rio autenticado. Inscrevendo novos listeners...");
                unsubscribeChecklists = listenForChecklists();
                if (nivel === 'lider' || nivel === 'pcma' || nivel === 'master') {
                    unsubscribePendingLider = listenForPendingChecklists('lider');
                }
                if (nivel === 'pcma' || nivel === 'master') {
                    unsubscribePendingPcma = listenForPendingChecklists('pcma');
                }
                // Apenas usu√°rios master devem monitorar todas as mudan√ßas de usu√°rio para a aba de gerenciamento
                if (nivel === 'master') {
                    unsubscribeUsers = listenForUsers();
                }
                unsubscribeAppliedChecklists = listenForAppliedChecklists();
                console.log("[setupTabs] Novos listeners inscritos.");
            } else {
                // Se n√£o h√° currentUser (ex: ap√≥s logout), garante que os cont√™ineres sejam limpos e os listeners desativados
                console.log("[setupTabs] Nenhum usu√°rio autenticado. Limpando cont√™ineres de dados.");
                document.getElementById('tag-cloud-aplicador').innerHTML = '<p class="text-center text-gray-500">Fa√ßa login para ver os checklists dispon√≠veis.</p>';
                document.getElementById('aplicador-form-container').classList.add('hidden');
                document.getElementById('lider-checklists-container').innerHTML = '<p class="text-center text-gray-500">Fa√ßa login para ver os checklists pendentes.</p>';
                document.getElementById('pcma-checklists-container').innerHTML = '<p class="text-center text-gray-500">Fa√ßa login para ver os checklists pendentes.</p>';
                document.getElementById('realizados-list-container').innerHTML = '<p class="text-center text-gray-500">Fa√ßa login para ver os checklists realizados.</p>';
                document.getElementById('tag-cloud-novos').innerHTML = '';
                document.getElementById('sections-container').innerHTML = '';
                document.getElementById('user-list').innerHTML = '<p class="text-center text-gray-500">Fa√ßa login para ver a lista de usu√°rios.</p>';
                document.getElementById('realizados-pagination').innerHTML = '';
                document.getElementById('user-pagination').innerHTML = '';
            }
        };

        document.getElementById('logout-btn').addEventListener('click', async () => {
            console.log("[Logout] Bot√£o de logout clicado. Realizando signOut...");
            // Desinscreve todos os listeners antes de fazer signOut para evitar erros de permiss√£o
            if (unsubscribeChecklists) { unsubscribeChecklists(); unsubscribeChecklists = null; }
            if (unsubscribePendingLider) { unsubscribePendingLider(); unsubscribePendingLider = null; }
            if (unsubscribePendingPcma) { unsubscribePendingPcma(); unsubscribePendingPcma = null; }
            if (unsubscribeAppliedChecklists) { unsubscribeAppliedChecklists(); unsubscribeAppliedChecklists = null; }
            if (unsubscribeUsers) { unsubscribeUsers(); unsubscribeUsers = null; }
            console.log("[Logout] Todos os listeners foram desinscritos.");

            await auth.signOut();
            // Limpa o estado do usu√°rio atual ap√≥s o logout
            currentUser = {
                appDocId: null,
                actualFirebaseAuthUid: null,
                nome: null,
                usuario: null,
                nivel: null,
                id: null,
                ativo: null,
            };
            console.log("[Logout] signOut conclu√≠do. onAuthStateChanged deve agora atualizar a UI e iniciar um login an√¥nimo.");
            // onAuthStateChanged ir√° lidar com a defini√ß√£o de currentUser para nulo e chamar showLoginScreen()
            // e setupTabs ent√£o desinscrever√° corretamente todos os listeners.
        });

        // --- ABA APLICADOR ---

        const listenForChecklists = () => {
            // Verifica se o usu√°rio est√° autenticado antes de tentar ler
            if (!currentUser || !currentUser.appDocId) {
                console.warn("[listenForChecklists] Usu√°rio n√£o autenticado, n√£o carregando checklists din√¢micos.");
                return null; // Retorna null se n√£o houver listener para desinscrever
            }
            // Acessa a cole√ß√£o 'dynamic_checklists' diretamente
            const q = query(collection(db, COLLECTIONS.DYNAMIC_CHECKLISTS));
            // Retorna a fun√ß√£o de unsubscribe
            return onSnapshot(q, (snapshot) => {
                const checklists = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("[listenForChecklists] Checklists din√¢micos atualizados:", checklists.length);
                renderTagCloud('aplicador', checklists);
                renderTagCloud('novos', checklists);
            }, (error) => {
                console.error("[listenForChecklists] Erro ao carregar checklists:", error);
                // CORRE√á√ÉO: S√≥ mostra o modal se o erro n√£o for de permiss√£o OU se o usu√°rio ainda estiver autenticado (pelo appDocId)
                if (error.code !== 'permission-denied' || (currentUser && currentUser.appDocId)) {
                    showModal('Erro', 'N√£o foi poss√≠vel carregar os checklists. Tente novamente.');
                } else {
                    console.log("[listenForChecklists] Erro de permiss√£o em um listener ap√≥s logout. Ignorando modal.");
                }
            });
        };

        const renderTagCloud = (containerId, checklists) => {
            const tagCloudContainer = document.getElementById(`tag-cloud-${containerId}`);
            tagCloudContainer.innerHTML = '';
            checklists.forEach(checklist => {
                const button = document.createElement('button');
                button.textContent = checklist.title;
                button.setAttribute('data-id', checklist.id);
                button.classList.add('tag-button', 'bg-white', 'text-gray-700', 'shadow-sm', 'hover:bg-gray-100');
                
                button.onclick = () => {
                    document.querySelectorAll(`#tag-cloud-${containerId} .tag-button`).forEach(btn => btn.classList.remove('active', 'bg-blue-500', 'text-white'));
                    button.classList.add('active', 'bg-blue-500', 'text-white');
                    
                    if (containerId === 'aplicador') {
                        renderAplicadorForm(checklist);
                    } else {
                        renderChecklistFormNovos(checklist);
                        document.getElementById('delete-selected-checklist-btn').classList.remove('hidden');
                    }
                };
                tagCloudContainer.appendChild(button);
            });
        };

        const renderAplicadorForm = (checklist) => {
            const container = document.getElementById('aplicador-form-container');
            const form = document.getElementById('aplicador-form');
            const titleElement = document.getElementById('aplicador-checklist-title');
            const sectionsContainer = document.getElementById('aplicador-sections-container');
            
            titleElement.textContent = checklist.title;
            sectionsContainer.innerHTML = '';
            form.setAttribute('data-checklist-id', checklist.id);
            form.setAttribute('data-checklist-title', checklist.title);

            document.getElementById('aplicador-name').value = `${currentUser.nome} (${currentUser.id})`;
            document.getElementById('frota').value = '';
            document.getElementById('os').value = '';
            document.getElementById('mecanico-name').value = '';

            document.getElementById('frota').addEventListener('input', (e) => {
                // Certifica que a hora inicial s√≥ √© preenchida uma vez
                if (e.target.value.trim().length > 0 && document.getElementById('start-time').value.trim() === '') {
                    const now = new Date();
                    document.getElementById('start-time').value = now.toLocaleString('pt-BR');
                }
            });

            document.getElementById('end-time').value = '';
            
            checklist.sections.forEach((section, sectionIndex) => {
                const sectionDiv = document.createElement('div');
                sectionDiv.classList.add('p-4', 'bg-gray-50', 'rounded-lg', 'shadow-inner');
                sectionDiv.innerHTML = `<h4 class="text-lg font-bold text-gray-800 mb-2">${section.sectionTitle}</h4>`;
                
                section.items.forEach((item, itemIndex) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.classList.add('mb-2', 'checklist-item-container');
                    
                    const itemTextContent = String(item.itemText || '').trim(); // Trim aqui
                    const emptyTextClass = itemTextContent.trim() === '' ? 'text-red-500 font-bold' : '';

                    let itemHtml = `
                        <p class="text-gray-700 font-medium ${emptyTextClass} item-text-display">
                            ${itemTextContent || 'ITEM SEM TEXTO DEFINIDO NO MODELO!'}
                        </p>
                    `;
                    
                    console.log(`[RENDER] Checklist "${checklist.title}", Se√ß√£o "${section.sectionTitle}", Item ${itemIndex}: "${itemTextContent}"`);

                    if (itemTextContent === '') { // Usa conte√∫do trimado para valida√ß√£o
                        console.error(`Erro: Texto do item n√£o encontrado para o item ${itemIndex} na se√ß√£o ${section.sectionTitle}.`, itemDiv);
                        // showModal('Aviso', `O texto para o item ${itemIndex + 1} na se√ß√£o "${sectionTitle}" √© obrigat√≥rio.`);
                        // Return not necessary here as it's just rendering, validation happens on submit
                    }
                    
                    if (item.itemType === 'radio') {
                        itemHtml += `
                            <div class="flex items-center space-x-4 mt-1">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="section-${sectionIndex}-item-${itemIndex}" value="ok" class="form-radio text-green-600" required>
                                    <span class="ml-2 text-gray-700">OK</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="section-${sectionIndex}-item-${itemIndex}" value="nao-ok" class="form-radio text-red-600" required>
                                    <span class="ml-2 text-gray-700">N√ÉO OK</span>
                                </label>
                            </div>
                            <div class="observacao-field hidden mt-2">
                                <label class="block text-sm font-medium text-gray-700">Observa√ß√£o (obrigat√≥ria)</label>
                                <textarea name="obs-section-${sectionIndex}-item-${itemIndex}" rows="2" class="mt-1 block w-full rounded-md border border-gray-400 shadow-sm" minlength="6" maxlength="300"></textarea>
                            </div>
                        `;
                    } else if (item.itemType === 'texto') {
                        itemHtml += `
                            <input type="text" name="section-${sectionIndex}-item-${itemIndex}" class="mt-1 block w-full rounded-md border border-gray-400 shadow-sm" required>
                        `;
                    } else if (item.itemType === 'dropdown') {
                        const optionsHtml = item.itemOptions.split(',').map(option => `<option value="${option.trim()}">${option.trim()}</option>`).join('');
                        itemHtml += `
                            <select name="section-${sectionIndex}-item-${itemIndex}" class="mt-1 block w-full rounded-md border border-gray-400 shadow-sm" required>
                                <option value="">Selecione uma op√ß√£o</option>
                                ${optionsHtml}
                            </select>
                        `;
                    }

                    itemDiv.innerHTML = itemHtml;

                    if (item.itemType === 'radio') {
                        itemDiv.querySelectorAll('input[type="radio"]').forEach(radio => {
                            radio.addEventListener('change', (e) => {
                                const obsField = itemDiv.querySelector('.observacao-field');
                                const textarea = itemDiv.querySelector('textarea');
                                if (e.target.value === 'nao-ok') {
                                    obsField.classList.remove('hidden');
                                    textarea.setAttribute('required', 'required');
                                } else {
                                    obsField.classList.add('hidden');
                                    textarea.removeAttribute('required');
                                }
                            });
                        });
                    }

                    sectionDiv.appendChild(itemDiv);
                });
                sectionsContainer.appendChild(sectionDiv);
            });
            container.classList.remove('hidden');
        };

        document.getElementById('aplicador-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const checklistId = form.getAttribute('data-checklist-id');
            const checklistTitle = form.getAttribute('data-checklist-title');
            
            const now = new Date();
            document.getElementById('end-time').value = now.toLocaleString('pt-BR'); // Preenche Hora Final aqui

            if (form['start-time'].value.trim() === '') {
                showModal('Aviso', 'O campo "Hora Inicial" √© obrigat√≥rio. Por favor, preencha a Frota para que seja gerado automaticamente.');
                return;
            }

            const responseData = {
                checklist: {
                    title: checklistTitle,
                    sections: []
                },
                frota: form.frota.value.trim(),
                os: form.os.value.trim(),
                aplicador: { 
                    nome: currentUser.nome, 
                    id: currentUser.id, 
                    appDocId: currentUser.appDocId, // Adicionado para valida√ß√£o de regras do Firestore
                }, 
                mecanico: form['mecanico-name'].value.trim(),
                data: now.toLocaleDateString('pt-BR'),
                horaInicial: form['start-time'].value.trim(),
                horaFinal: now.toLocaleString('pt-BR'),
                status: {
                    lider: 'pendente',
                    pcma: 'pendente'
                },
                criadoEm: now.toISOString()
            };
            
            const sections = [];
            const formSections = document.getElementById('aplicador-sections-container').querySelectorAll('.p-4.bg-gray-50');
            for (let sectionIndex = 0; sectionIndex < formSections.length; sectionIndex++) {
                const sectionDiv = formSections[sectionIndex];
                const sectionTitleElement = sectionDiv.querySelector('h4');
                const sectionTitle = sectionTitleElement ? sectionTitleElement.textContent.trim() : `Se√ß√£o ${sectionIndex + 1}`; // Trim aqui
                
                const sectionResponses = [];
                const items = sectionDiv.querySelectorAll('.checklist-item-container');
                
                for (let itemIndex = 0; itemIndex < items.length; itemIndex++) {
                    const itemDiv = items[itemIndex];
                    const itemTextElement = itemDiv.querySelector('.item-text-display');
                    const itemText = itemTextElement ? String(itemTextElement.textContent || '').trim() : ''; // Trim aqui
                    
                    console.log(`[VALIDATION - RADICAL] Checklist "${checklistTitle}", Se√ß√£o "${sectionTitle}", Item ${itemIndex}: "${itemText}" (Length: ${itemText.length}, Trimmed Length: ${itemText.trim().length})`);

                    if (itemText.trim() === '') {
                        console.error(`Erro: Texto do item n√£o encontrado para o item ${itemIndex} na se√ß√£o ${sectionTitle}.`, itemDiv);
                        showModal('Aviso', `O texto para o item ${itemIndex + 1} na se√ß√£o "${sectionTitle}" √© obrigat√≥rio.`);
                        return;
                    }
                    
                    let response = { itemText, status: null, observacao: null, value: null };
                    
                    const radioOk = itemDiv.querySelector(`input[name="section-${sectionIndex}-item-${itemIndex}"][value="ok"]`);
                    const radioNaoOk = itemDiv.querySelector(`input[name="section-${sectionIndex}-item-${itemIndex}"][value="nao-ok"]`);
                    const textField = itemDiv.querySelector(`input[name="section-${sectionIndex}-item-${itemIndex}"][type="text"]`);
                    const dropdownField = itemDiv.querySelector(`select[name="section-${sectionIndex}-item-${itemIndex}"]`);


                    if (radioOk || radioNaoOk) {
                        const radio = itemDiv.querySelector(`input[name="section-${sectionIndex}-item-${itemIndex}"]:checked`);
                        if (!radio) {
                            showModal('Aviso', `Por favor, selecione OK ou N√ÉO OK para o item "${itemText}".`);
                            return;
                        }
                        response.status = radio.value;
                        const observacaoTextarea = itemDiv.querySelector(`textarea[name="obs-section-${sectionIndex}-item-${itemIndex}"]`);
                        response.observacao = observacaoTextarea ? observacaoTextarea.value.trim() : ''; // Trim aqui
                        if (response.status === 'nao-ok' && response.observacao.trim() === '') {
                             showModal('Aviso', `O campo de observa√ß√£o √© obrigat√≥rio para o item "${itemText}" (N√ÉO OK).`);
                             return;
                        }
                    } else if (textField) {
                        if (textField.value.trim() === '') {
                            showModal('Aviso', `O campo de texto para o item "${itemText}" √© obrigat√≥rio.`);
                            return;
                        }
                        response.value = textField.value.trim(); // Trim aqui
                    } else if (dropdownField) {
                        if (dropdownField.value.trim() === '') {
                            showModal('Aviso', `Por favor, selecione uma op√ß√£o para o item "${itemText}".`);
                            return;
                        }
                        response.value = dropdownField.value.trim(); // Trim aqui
                    }
                    sectionResponses.push(response);
                }
                sections.push({ sectionTitle, items: sectionResponses });
            }
            responseData.checklist.sections = sections;

            try {
                // Acessa a cole√ß√£o 'applied_checklists' diretamente
                // O ID do documento √© a frota, como no seu modelo
                const docRef = doc(db, COLLECTIONS.APPLIED_CHECKLISTS, responseData.frota);
                await retryWithExponentialBackoff(() => setDoc(docRef, responseData, { merge: false }));
                showToast('Respostas salvas com sucesso!', 'success');
                renderAplicadorForm({ id: checklistId, title: checklistTitle, sections: [] });
                document.getElementById('aplicador-form-container').classList.add('hidden');
                document.querySelectorAll('#tag-cloud-aplicador .tag-button').forEach(btn => btn.classList.remove('active', 'bg-blue-500', 'text-white'));
            } catch (error) {
                console.error("Erro ao salvar a resposta do aplicador:", error);
                if (error.code === 'permission-denied') {
                    showModal('Erro de Permiss√£o', 'Voc√™ n√£o tem permiss√£o para salvar este checklist.');
                } else {
                    showModal('Erro', 'N√£o foi poss√≠vel salvar as respostas. Tente novamente.');
                }
            }
        });

        // --- ABA NOVOS (Cria√ß√£o/Edi√ß√£o) ---

        const createNewSectionDivHtml = (sectionTitle = '') => {
            return `
                <div class="section-card p-4 bg-gray-50 rounded-lg shadow-inner mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block flex-grow mr-4">
                            <span class="text-sm font-medium text-gray-700">T√≠tulo da Se√ß√£o</span>
                            <input type="text" name="section-title" value="${sectionTitle}" class="mt-1 block w-full rounded-md border border-gray-400 shadow-sm" required>
                        </label>
                        <button type="button" class="remove-section-btn text-red-500 hover:text-red-700 text-2xl" title="Remover Se√ß√£o">&times;</button>
                    </div>
                    <div class="items-container space-y-2">
                        ${createNewItemDivHtml()}
                    </div>
                    <div class="flex justify-end mt-4">
                        <button type="button" class="add-item-btn bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm font-semibold py-1 px-3 rounded-full shadow-sm"><i class="fas fa-plus-circle mr-1"></i> Adicionar Item</button>
                    </div>
                </div>
            `;
        };

        const createNewItemDivHtml = (item = { itemText: '', itemType: 'radio', itemOptions: '' }) => {
            const itemOptionsHiddenClass = item.itemType === 'dropdown' ? '' : 'hidden';
            return `
                <div class="flex items-center space-x-2">
                    <input type="text" name="item-text" value="${item.itemText || ''}" placeholder="Texto do item" class="flex-grow rounded-md border border-gray-400 shadow-sm text-sm" required>
                    <select name="item-type" class="rounded-md border border-gray-400 shadow-sm text-sm">
                        <option value="radio" ${item.itemType === 'radio' ? 'selected' : ''}>OK/N√ÉO OK</option>
                        <option value="texto" ${item.itemType === 'texto' ? 'selected' : ''}>Texto</option>
                        <option value="dropdown" ${item.itemType === 'dropdown' ? 'selected' : ''}>Menu Suspenso</option>
                    </select>
                    <button type="button" class="remove-item-btn text-red-500 hover:text-red-700 text-2xl" title="Remover Item">&times;</button>
                    <div class="item-options-container ${itemOptionsHiddenClass} mt-2 w-full">
                        <label class="block text-sm font-medium text-gray-700">Op√ß√µes (separadas por v√≠rgula)</label>
                        <textarea name="item-options" rows="2" class="mt-1 block w-full rounded-md border border-gray-400 shadow-sm text-sm" placeholder="Ex: Op√ß√£o A, Op√ß√£o B, Op√ß√£o C">${item.itemOptions || ''}</textarea>
                    </div>
                </div>
            `;
        };

        const attachDynamicListeners = (parentDiv) => {
            parentDiv.querySelectorAll('select[name="item-type"]').forEach(select => {
                select.addEventListener('change', (e) => {
                    const itemDiv = e.target.closest('.flex.items-center.space-x-2');
                    const itemOptionsContainer = itemDiv.querySelector('.item-options-container');
                    const textarea = itemOptionsContainer.querySelector('textarea');
                    if (e.target.value === 'dropdown') {
                        itemOptionsContainer.classList.remove('hidden');
                        textarea.setAttribute('required', 'required');
                    } else {
                        itemOptionsContainer.classList.add('hidden');
                        textarea.removeAttribute('required');
                    }
                });
            });

            parentDiv.querySelectorAll('.remove-item-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const itemDiv = e.target.closest('.flex.items-center.space-x-2');
                    itemDiv.remove();
                });
            });

            parentDiv.querySelectorAll('.remove-section-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const sectionDiv = e.target.closest('.section-card');
                    sectionDiv.remove();
                });
            });

            parentDiv.querySelectorAll('.add-item-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const sectionDiv = e.target.closest('.section-card');
                    addItemToSection(sectionDiv);
                });
            });
        };

        const addSectionToForm = () => {
            const sectionsContainer = document.getElementById('sections-container');
            const newSectionWrapper = document.createElement('div');
            newSectionWrapper.innerHTML = createNewSectionDivHtml();
            const newSectionDiv = newSectionWrapper.firstElementChild;
            sectionsContainer.appendChild(newSectionDiv);
            attachDynamicListeners(newSectionDiv);
        };

        const addItemToSection = (sectionDiv) => {
            const itemsContainer = sectionDiv.querySelector('.items-container');
            const newItemWrapper = document.createElement('div');
            newItemWrapper.innerHTML = createNewItemDivHtml();
            const newItemDiv = newItemWrapper.firstElementChild;
            itemsContainer.appendChild(newItemDiv);
            attachDynamicListeners(newItemDiv);
        };

        const renderChecklistFormNovos = (checklist = { id: null, title: '', sections: [] }) => {
            console.log('renderChecklistFormNovos called with checklist:', JSON.parse(JSON.stringify(checklist)));
            const form = document.getElementById('novos-checklist-form');
            const titleInput = document.getElementById('checklist-title');
            const sectionsContainer = document.getElementById('sections-container');
            const novosTitle = document.getElementById('novos-title');

            form.setAttribute('data-checklist-id', checklist.id || '');
            novosTitle.textContent = checklist.id ? `Editando: ${checklist.title}` : 'Novo Checklist';
            titleInput.value = checklist.title;
            sectionsContainer.innerHTML = '';
            console.log('SectionsContainer HTML after clear:', sectionsContainer.innerHTML);

            if (checklist.id) {
                document.getElementById('delete-selected-checklist-btn').classList.remove('hidden');
            } else {
                document.getElementById('delete-selected-checklist-btn').classList.add('hidden');
            }

            if (checklist.sections.length === 0) {
                addSectionToForm();
            } else {
                checklist.sections.forEach((section) => {
                    const sectionWrapper = document.createElement('div');
                    sectionWrapper.innerHTML = createNewSectionDivHtml(section.sectionTitle);
                    const sectionDiv = sectionWrapper.firstElementChild;
                    const itemsContainer = sectionDiv.querySelector('.items-container');
                    itemsContainer.innerHTML = '';
                    
                    section.items.forEach(item => {
                        const itemWrapper = document.createElement('div');
                        itemWrapper.innerHTML = createNewItemDivHtml(item);
                        const itemDiv = itemWrapper.firstElementChild;
                        itemsContainer.appendChild(itemDiv);
                        attachDynamicListeners(itemDiv);
                    });
                    sectionsContainer.appendChild(sectionDiv);
                    attachDynamicListeners(sectionDiv);
                });
            }
        };

        const getFormDataNovos = () => {
            const form = document.getElementById('novos-checklist-form');
            const title = form.querySelector('#checklist-title').value.trim(); // Trim aqui
            const sections = [];
            form.querySelectorAll('.section-card').forEach(sectionDiv => {
                const sectionTitle = sectionDiv.querySelector('input[name="section-title"]').value.trim(); // Trim aqui
                const items = [];
                sectionDiv.querySelectorAll('.items-container > div').forEach(itemDiv => {
                    const itemText = itemDiv.querySelector('input[name="item-text"]').value.trim(); // Trim aqui
                    const itemType = itemDiv.querySelector('select[name="item-type"]').value;
                    let itemOptions = '';
                    if (itemType === 'dropdown') {
                        itemOptions = itemDiv.querySelector('textarea[name="item-options"]').value.trim(); // Trim aqui
                    }
                    items.push({ itemText, itemType, itemOptions });
                });
                sections.push({ sectionTitle, items });
            });
            return { title, sections };
        };

        document.getElementById('novos-checklist-form').addEventListener('click', (e) => {
            if (e.target.id === 'add-section-btn' || e.target.closest('#add-section-btn')) {
                addSectionToForm();
            }
            else if (e.target.classList.contains('remove-item-btn') || e.target.closest('.remove-item-btn')) {
                const itemDiv = e.target.closest('.flex.items-center.space-x-2');
                itemDiv.remove();
            } else if (e.target.classList.contains('remove-section-btn') || e.target.closest('.remove-section-btn')) {
                const sectionDiv = e.target.closest('.section-card');
                sectionDiv.remove();
            }
        });

        document.getElementById('save-new-checklist-btn').addEventListener('click', async () => {
            if (!currentUser || !currentUser.appDocId) {
                showModal('Erro de Permiss√£o', 'Voc√™ precisa estar logado para criar/editar checklists.');
                console.warn('Opera√ß√£o negada: Usu√°rio n√£o autenticado para salvar checklist.');
                return;
            }
            console.log(`[save-new-checklist-btn] Usu√°rio atual n√≠vel: ${currentUser.nivel}`); // Log para depura√ß√£o
            if (!['lider', 'pcma', 'master'].includes(currentUser.nivel)) {
                showModal('Erro de Permiss√£o', 'Seu n√≠vel de acesso n√£o permite criar/editar checklists.');
                console.warn(`Opera√ß√£o negada: Usu√°rio ${currentUser.appDocId} (${currentUser.nivel}) tentou salvar checklist sem permiss√£o.`);
                return;
            }

            const formData = getFormDataNovos();
            
            if (formData.title.trim() === '') {
                showModal('Aviso', 'O t√≠tulo do checklist n√£o pode ser vazio.');
                return;
            }

            if (formData.sections.length === 0) {
                showModal('Aviso', 'O checklist deve conter pelo menos uma se√ß√£o.');
                return;
            }

            for (const section of formData.sections) {
                if (section.sectionTitle.trim() === '') {
                    showModal('Aviso', 'Todos os t√≠tulos de se√ß√£o devem ser preenchidos.');
                    return;
                }
                if (section.items.length === 0) {
                    showModal('Aviso', `A se√ß√£o "${section.sectionTitle}" deve conter pelo menos um item.`);
                    return;
                }
                for (const item of section.items) {
                    if (item.itemText.trim() === '') {
                        showModal('Aviso', `Todos os itens na se√ß√£o "${section.sectionTitle}" devem ter um texto.`);
                        return;
                    }
                    if (item.itemType === 'dropdown' && item.itemOptions.trim() === '') {
                        showModal('Aviso', `O item "${item.itemText}" do tipo "Menu Suspenso" precisa ter op√ß√µes definidas (separadas por v√≠rgula).`);
                        return;
                    }
                }
            }

            const form = document.getElementById('novos-checklist-form');
            const checklistId = form.getAttribute('data-checklist-id');

            const dataToSave = {
                ...formData,
                criadoPor: currentUser.id,
                dataCriacao: new Date().toISOString()
            };

            console.log("Dados do checklist sendo salvos:", JSON.stringify(dataToSave, null, 2));

            try {
                // Acessa a cole√ß√£o 'dynamic_checklists' diretamente
                if (checklistId) {
                    const docRef = doc(db, COLLECTIONS.DYNAMIC_CHECKLISTS, checklistId);
                    await retryWithExponentialBackoff(() => setDoc(docRef, dataToSave, { merge: false }));
                    showModal('Sucesso', 'Checklist atualizado com sucesso!');
                } else {
                    const docRef = doc(db, COLLECTIONS.DYNAMIC_CHECKLISTS, formData.title);
                    await retryWithExponentialBackoff(() => setDoc(docRef, dataToSave));
                    showModal('Sucesso', 'Novo checklist salvo com sucesso!');
                }
                renderChecklistFormNovos();
            }
            catch (error) {
                console.error("Erro ao salvar o checklist:", error);
                if (error.code === 'permission-denied') {
                    showModal('Erro de Permiss√£o', 'Voc√™ n√£o tem permiss√£o para salvar este checklist.');
                } else {
                    showModal('Erro', 'N√£o foi poss√≠vel salvar o checklist. Por favor, tente novamente.');
                }
            }
        });

        document.getElementById('delete-selected-checklist-btn').addEventListener('click', () => {
            if (!currentUser || !currentUser.appDocId) {
                showModal('Erro de Permiss√£o', 'Voc√™ precisa estar logado para excluir checklists.');
                console.warn('Opera√ß√£o negada: Usu√°rio n√£o autenticado para excluir checklist.');
                return;
            }
            console.log(`[delete-selected-checklist-btn] Usu√°rio atual n√≠vel: ${currentUser.nivel}`); // Log para depura√ß√£o
            if (!['lider', 'pcma', 'master'].includes(currentUser.nivel)) {
                showModal('Erro de Permiss√£o', 'Seu n√≠vel de acesso n√£o permite excluir checklists.');
                console.warn(`Opera√ß√£o negada: Usu√°rio ${currentUser.appDocId} (${currentUser.nivel}) tentou excluir checklist sem permiss√£o.`);
                return;
            }

            const form = document.getElementById('novos-checklist-form');
            const selectedId = form.getAttribute('data-checklist-id');
            const selectedTitle = document.getElementById('checklist-title').value;

            if (selectedId) {
                showConfirmModal('Excluir Checklist', `Tem certeza que deseja excluir o checklist "${selectedTitle}"?`, async () => {
                    try {
                        // Acessa a cole√ß√£o 'dynamic_checklists' diretamente
                        const docRef = doc(db, COLLECTIONS.DYNAMIC_CHECKLISTS, selectedId);
                        await retryWithExponentialBackoff(() => deleteDoc(docRef));
                        showModal('Sucesso', 'Checklist exclu√≠do com sucesso!');
                        renderChecklistFormNovos();
                        document.querySelectorAll('#tag-cloud-novos .tag-button').forEach(btn => btn.classList.remove('active'));
                        document.getElementById('delete-selected-checklist-btn').classList.add('hidden');
                    } catch (error) {
                        console.error("Erro ao excluir o checklist:", error);
                        if (error.code === 'permission-denied') {
                            showModal('Erro de Permiss√£o', 'Voc√™ n√£o tem permiss√£o para excluir este checklist.');
                        } else {
                            showModal('Erro', 'N√£o foi poss√≠vel excluir o checklist. Por favor, tente novamente.');
                        }
                    }
                });
            } else {
                showModal('Aviso', 'Nenhum checklist selecionado para exclus√£o.');
            }
        });
        
        // ABA L√çDER e PCMA

        const listenForPendingChecklists = (role) => {
            // Verifica se o usu√°rio est√° autenticado antes de tentar ler
            if (!currentUser || !currentUser.appDocId) {
                console.warn(`[listenForPendingChecklists] Usu√°rio n√£o autenticado, n√£o carregando checklists pendentes para ${role}.`);
                return null; // Retorna null
            }
            // Acessa a cole√ß√£o 'applied_checklists' diretamente
            const q = query(
                collection(db, COLLECTIONS.APPLIED_CHECKLISTS),
                where(`status.${role}`, "==", "pendente")
            );
            // Retorna a fun√ß√£o de unsubscribe
            return onSnapshot(q, (snapshot) => {
                const checklists = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log(`[listenForPendingChecklists] Checklists pendentes para ${role} atualizados:`, checklists.length);
                renderChecklistsForApproval(role, checklists);
            }, (error) => {
                console.error(`[listenForPendingChecklists] Erro ao carregar checklists pendentes para ${role}:`, error);
            });
        };

        const renderChecklistsForApproval = (role, checklists) => {
            const container = document.getElementById(`${role}-checklists-container`);
            container.innerHTML = '';
            
            const checksToShow = checklists.slice(0, PAGINATION_LIMIT);

            if (checksToShow.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">Nenhum checklist pendente para valida√ß√£o.</p>';
                return;
            }

            checksToShow.forEach(checklist => {
                const checklistDiv = document.createElement('div');
                checklistDiv.classList.add('p-6', 'bg-white', 'rounded-lg', 'shadow-md', 'mb-4');
                checklistDiv.innerHTML = `
                    <h3 class="text-lg font-bold mb-2">${checklist.checklist.title} - Frota: ${checklist.frota}</h3>
                    <p class="text-sm text-gray-600"><strong>Aplicador:</strong> ${checklist.aplicador.nome} (${checklist.aplicador.id})</p>
                    <p class="text-sm text-gray-600"><strong>N¬∫ OS:</strong> ${checklist.os}</p>
                    <p class="text-sm text-gray-600 mb-4"><strong>Data:</strong> ${new Date(checklist.criadoEm).toLocaleString('pt-BR')}</p>
                    <button class="view-report-btn bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-full">Visualizar Relat√≥rio</button>
                    <div class="mt-4 flex space-x-2">
                        <button class="approve-btn bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-full transition-colors">Aprovar</button>
                        <button class="reject-btn bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-full transition-colors">Reprovar</button>
                    </div>
                `;
                
                checklistDiv.querySelector('.view-report-btn').addEventListener('click', () => renderReportModal(checklist));
                checklistDiv.querySelector('.approve-btn').addEventListener('click', () => updateChecklistStatus(checklist.id, role, 'aprovado'));
                checklistDiv.querySelector('.reject-btn').addEventListener('click', () => updateChecklistStatus(checklist.id, role, 'reprovado'));
                
                container.appendChild(checklistDiv);
            });
        };
        
        const updateChecklistStatus = async (checklistId, role, status) => {
            if (!currentUser || !currentUser.appDocId) {
                showModal('Erro de Permiss√£o', 'Voc√™ precisa estar logado para atualizar o status do checklist.');
                console.warn('Opera√ß√£o negada: Usu√°rio n√£o autenticado para atualizar status.');
                return;
            }
            if (!['lider', 'pcma', 'master'].includes(currentUser.nivel)) {
                showModal('Erro de Permiss√£o', 'Seu n√≠vel de acesso n√£o permite atualizar o status deste checklist.');
                console.warn(`Opera√ß√£o negada: Usu√°rio ${currentUser.appDocId} (${currentUser.nivel}) tentou atualizar status sem permiss√£o.`);
                return;
            }

            try {
                // Acessa a cole√ß√£o 'applied_checklists' diretamente
                const docRef = doc(db, COLLECTIONS.APPLIED_CHECKLISTS, checklistId);
                console.log(`[updateChecklistStatus] Atualizando status do checklist ${checklistId} para ${role}: ${status}`);
                await retryWithExponentialBackoff(() => updateDoc(docRef, { [`status.${role}`]: status }));
                showToast(`Checklist ${status} por ${role} com sucesso!`, 'success');
                console.log(`[updateChecklistStatus] Status do checklist ${checklistId} atualizado com sucesso para ${role}: ${status}.`);
            }
            catch (error) {
                console.error(`[updateChecklistStatus] Erro ao atualizar status do checklist para ${role}:`, error);
                if (error.code === 'permission-denied') {
                    showModal('Erro de Permiss√£o', 'Voc√™ n√£o tem permiss√£o para atualizar o status deste checklist.');
                } else {
                    showModal('Erro', `N√£o foi poss√≠vel atualizar o status. Tente novamente.`);
                }
            }
        };

        // ABA REALIZADOS

        let allAppliedChecklists = [];
        let currentPageRealizados = 1;
        
        const renderRealizadosList = (page) => {
            const container = document.getElementById('realizados-list-container');
            const paginationContainer = document.getElementById('realizados-pagination');
            container.innerHTML = '';
            paginationContainer.innerHTML = '';
            
            // ATEN√á√ÉO: start e end foram movidos para dentro da fun√ß√£o listenForAppliedChecklists para escopo correto
            // Aqui eles precisam ser definidos com base na p√°gina atual e no limite de pagina√ß√£o
            const start = (page - 1) * PAGINATION_LIMIT;
            const end = start + PAGINATION_LIMIT;
            const checksToDisplay = allAppliedChecklists.slice(start, end);

            if (checksToDisplay.length === 0 && page === 1) {
                container.innerHTML = '<p class="text-center text-gray-500">Nenhum checklist realizado ainda.</p>';
                return;
            }

            checksToDisplay.forEach(checklist => {
                const statusLider = checklist.status.lider;
                const statusPcma = checklist.status.pcma;
                
                const statusLiderColor = statusLider === 'aprovado' ? 'bg-green-200 text-green-800' :
                                       statusLider === 'reprovado' ? 'bg-red-200 text-red-800' :
                                       'bg-yellow-200 text-yellow-800';
                
                const statusPcmaColor = statusPcma === 'aprovado' ? 'bg-green-200 text-green-800' :
                                       statusPcma === 'reprovado' ? 'bg-red-200 text-red-800' :
                                       'bg-yellow-200 text-yellow-800';

                const checklistDiv = document.createElement('div');
                checklistDiv.classList.add('p-6', 'bg-white', 'rounded-lg', 'shadow-md', 'mb-4');
                checklistDiv.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <p class="text-sm text-gray-600"><strong>Frota:</strong> ${checklist.frota}</p>
                        <p class="text-sm text-gray-600"><strong>N¬∫ OS:</strong> ${checklist.os}</p>
                        <p class="text-sm text-gray-600"><strong>Aplicador:</strong> ${checklist.aplicador.nome} (${checklist.aplicador.id})</p>
                        <p class="text-sm text-gray-600"><strong>Mec√¢nico:</strong> ${checklist.mecanico}</p>
                        <p class="text-sm text-gray-600"><strong>Data:</strong> ${new Date(checklist.criadoEm).toLocaleDateString('pt-BR')}</p>
                        <p class="text-sm text-gray-600"><strong>Hora Inicial:</strong> ${checklist.horaInicial}</p>
                        <p class="text-sm text-gray-600"><strong>Hora Final:</strong> ${checklist.horaFinal}</p>
                    </div>
                    <div class="flex items-center space-x-4 mt-4">
                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusLiderColor}">L√≠der: ${statusLider}</span>
                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusPcmaColor}">PCMA: ${statusPcma}</span>
                        <button class="view-report-btn bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1 px-4 rounded-full text-sm">Visualizar Relat√≥rio</button>
                    </div>
                `;
                
                checklistDiv.querySelector('.view-report-btn').addEventListener('click', () => renderReportModal(checklist));
                container.appendChild(checklistDiv);
            });
            
            const pageCount = Math.ceil(allAppliedChecklists.length / PAGINATION_LIMIT);
            for (let i = 1; i <= pageCount; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.classList.add('px-3', 'py-1', 'rounded-full', 'text-sm', 'font-medium', 'hover:bg-gray-200');
                if (i === page) {
                    pageBtn.classList.add('bg-blue-500', 'text-white', 'hover:bg-blue-600');
                } else {
                    pageBtn.classList.add('bg-gray-100', 'text-gray-700');
                }
                pageBtn.addEventListener('click', () => {
                    currentPageRealizados = i;
                    renderRealizadosList(currentPageRealizados);
                });
                paginationContainer.appendChild(pageBtn);
            }
        };
        
        const listenForAppliedChecklists = () => {
            // Verifica se o usu√°rio est√° autenticado antes de tentar ler
            if (!currentUser || !currentUser.appDocId) {
                console.warn("[listenForAppliedChecklists] Usu√°rio n√£o autenticado, n√£o carregando checklists aplicados.");
                return null; // Retorna null
            }
            // Acessa a cole√ß√£o 'applied_checklists' diretamente
            const q = query(collection(db, COLLECTIONS.APPLIED_CHECKLISTS));
            // Retorna a fun√ß√£o de unsubscribe
            return onSnapshot(q, (snapshot) => {
                allAppliedChecklists = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allAppliedChecklists.sort((a, b) => {
                    const statusA = (a.status.lider === 'pendente' || a.status.pcma === 'pendente');
                    const statusB = (b.status.lider === 'pendente' || b.status.pcma === 'pendente');
                    return statusB - statusA;
                });
                console.log("[listenForAppliedChecklists] Checklists aplicados atualizados:", allAppliedChecklists.length);
                renderRealizadosList(currentPageRealizados);
            }, (error) => {
                console.error("[listenForAppliedChecklists] Erro ao carregar checklists realizados:", error);
            });
        };
        
        const renderReportModal = (checklist) => {
            const reportContent = document.getElementById('report-content');
            const reportModal = document.getElementById('report-modal'); 
            reportContent.innerHTML = '';
            reportModal.setAttribute('data-id', checklist.id);
            reportModal.setAttribute('data-frota', checklist.frota);
            
            let htmlContent = `
                <h2 class="text-2xl font-bold mb-4">${checklist.checklist.title}</h2>
                <p><strong>Frota:</strong> ${checklist.frota}</p>
                <p><strong>N¬∫ OS:</strong> ${checklist.os}</p>
                <p><strong>Aplicador:</strong> ${checklist.aplicador.nome} (${checklist.aplicador.id})</p>
                <p><strong>Mec√¢nico:</strong> ${checklist.mecanico}</p>
                <p><strong>Data:</strong> ${new Date(checklist.criadoEm).toLocaleDateString('pt-BR')}</p>
                <p><strong>Hora Inicial:</strong> ${checklist.horaInicial}</p>
                <p><strong>Hora Final:</strong> ${checklist.horaFinal}</p>
                <p class="mt-4"><strong>Status L√≠der:</strong> <span class="font-bold">${checklist.status.lider}</span></p>
                <p><strong>Status PCMA:</strong> <span class="font-bold">${checklist.status.pcma}</span></p>
                <hr class="my-4">
            `;
            
            checklist.checklist.sections.forEach(section => {
                htmlContent += `
                    <h3 class="text-xl font-bold mt-4 mb-2">${section.sectionTitle}</h3>
                    <ul class="list-disc list-inside space-y-2">
                `;
                section.items.forEach(item => {
                    let statusHtml = '';
                    let observacao = item.observacao || '';
                    if (item.status) {
                        statusHtml = `<span class="text-green-600 font-bold">${item.status.toUpperCase()}</span>`;
                    } else if (typeof item.value === 'boolean') {
                         statusHtml = `<span class="text-blue-600 font-bold">${item.value ? 'Marcado' : 'N√£o Marcado'}</span>`;
                    } else if (item.value) {
                        statusHtml = `<span class="font-bold">${item.value}</span>`;
                    }

                    htmlContent += `
                        <li>
                            <span>${item.itemText}: ${statusHtml}</span>
                            ${item.observacao ? `<p class="pl-4 text-sm text-gray-500 italic">Observa√ß√£o: ${item.observacao}</p>` : ''}
                        </li>
                    `;
                });
                htmlContent += `</ul>`;
            });
            
            reportContent.innerHTML = htmlContent;
            reportModal.style.display = 'flex';
        };

        document.getElementById('report-modal-close-btn').addEventListener('click', hideModal);

        // --- ABA CADASTRO ---

        let allUsers = []; // This will now hold the deduplicated list
        let currentPageUsers = 1; // Keep track of current page for pagination

        const listenForUsers = () => {
            // Verifica se o usu√°rio est√° autenticado antes de tentar ler
            if (!currentUser || !currentUser.appDocId) {
                console.warn("[listenForUsers] Usu√°rio n√£o autenticado, n√£o carregando lista de usu√°rios.");
                return null; // Retorna null
            }
            // Acessa a cole√ß√£o 'users' diretamente
            const q = query(collection(db, COLLECTIONS.USERS));
            // Retorna a fun√ß√£o de unsubscribe
            return onSnapshot(q, (snapshot) => {
                const uniqueUsersMap = new Map(); // Key: usuario (nome de login), Value: o melhor documento de usu√°rio

                snapshot.docs.forEach(docSnap => {
                    const userData = { appDocId: docSnap.id, ...docSnap.data() }; 
                    const username = userData.usuario;

                    const existingUser = uniqueUsersMap.get(username);

                    if (!existingUser) {
                        uniqueUsersMap.set(username, userData);
                    } else {
                        // Prioriza o documento que tem um `actualFirebaseAuthUid` definido
                        // e, se poss√≠vel, aquele cujo `appDocId` (ID do documento) coincide com `actualFirebaseAuthUid`
                        const currentHasFirebaseAuthUid = !!userData.actualFirebaseAuthUid;
                        const existingHasFirebaseAuthUid = !!existingUser.actualFirebaseAuthUid;
                        const isCurrentCanonical = userData.appDocId === userData.actualFirebaseAuthUid;
                        const isExistingCanonical = existingUser.appDocId === existingUser.actualFirebaseAuthUid;

                        if (isCurrentCanonical) {
                            uniqueUsersMap.set(username, userData); // Se o atual √© can√¥nico, ele √© o melhor
                        } else if (isExistingCanonical) {
                            // Mant√©m o existente (n√£o faz nada), pois ele j√° √© o can√¥nico
                        } else if (currentHasFirebaseAuthUid && !existingHasFirebaseAuthUid) {
                            uniqueUsersMap.set(username, userData); // Se o atual tem UID de auth e o existente n√£o, o atual √© melhor
                        }
                        // Se nenhuma das condi√ß√µes acima for atendida, mant√©m o existingUser.
                        // Isso lida com casos onde ambos n√£o s√£o can√¥nicos ou ambos t√™m UID de auth mas nenhum √© 'canonical'
                        // (i.e. seu ID de documento n√£o √© o UID de auth, o que implica que √© um duplicado ou um registro antigo).
                    }
                });

                // Converte os valores do mapa em um array, filtrando quaisquer documentos obsoletos explicitamente marcados.
                allUsers = Array.from(uniqueUsersMap.values()).filter(user => !user.isObsolete);
                console.log("[listenForUsers] Lista de usu√°rios atualizada:", allUsers.length, "usu√°rios (deduplicados e filtrados).");
                renderUserList(currentPageUsers);
            }, (error) => {
                console.error("[listenForUsers] Erro ao carregar usu√°rios:", error);
            });
        };

        const renderUserList = (page, searchTerm = '') => {
            const userListContainer = document.getElementById('user-list');
            const paginationContainer = document.getElementById('user-pagination');
            userListContainer.innerHTML = '';
            paginationContainer.innerHTML = '';

            const isMaster = currentUser && currentUser.nivel === 'master';
            if (!isMaster) {
                return;
            } else {
                document.getElementById('add-user-form').classList.remove('hidden');
                document.getElementById('access-level-container').classList.remove('hidden');
                document.getElementById('user-search').classList.remove('hidden');
                document.getElementById('import-xlsx-btn').classList.remove('hidden');
                document.getElementById('import-csv-btn').classList.remove('hidden');
            }

            const filteredUsers = allUsers.filter(user => 
                // Filtra pela barra de busca
                (user.nome.toLowerCase().includes(searchTerm.toLowerCase()) ||
                user.usuario.toLowerCase().includes(searchTerm.toLowerCase()) ||
                user.id.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (user.actualFirebaseAuthUid && user.actualFirebaseAuthUid.toLowerCase().includes(searchTerm.toLowerCase())) ||
                (user.appDocId && user.appDocId.toLowerCase().includes(searchTerm.toLowerCase()))) // Adicionado busca por appDocId
            );

            const start = (page - 1) * PAGINATION_LIMIT;
            const end = start + PAGINATION_LIMIT;
            const usersToDisplay = filteredUsers.slice(start, end);

            if (usersToDisplay.length === 0 && page === 1) {
                userListContainer.innerHTML = '<p class="text-center text-gray-500">Nenhum usu√°rio encontrado.</p>';
                return;
            }

            usersToDisplay.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.classList.add('p-4', 'bg-gray-100', 'rounded-lg', 'shadow-sm', 'flex', 'flex-col', 'sm:flex-row', 'sm:justify-between', 'sm:items-center');
                userDiv.innerHTML = `
                    <div class="mb-2 sm:mb-0">
                        <p class="font-semibold text-lg">${user.nome} (<span class="text-blue-700">${user.usuario}</span>)</p>
                        <p class="text-sm text-gray-600">ID USINA: <span class="font-medium">${user.id}</span></p>
                        <p class="text-sm text-gray-600 break-words">Doc ID (App): <span class="font-medium">${user.appDocId}</span></p>
                        <p class="text-sm text-gray-600 break-words">Firebase UID: <span class="font-medium">${user.actualFirebaseAuthUid || 'N/A'}</span></p>
                        <p class="text-sm text-gray-600">N√≠vel: <span class="font-medium">${user.nivel}</span></p>
                        <p class="text-sm text-gray-600">Ativo: <span class="font-medium">${user.ativo ? 'Sim' : 'N√£o'}</span></p>
                        <p class="text-sm text-gray-600">Criado em: <span class="font-medium">${user.criadoEm ? new Date(user.criadoEm.toDate()).toLocaleString('pt-BR') : 'N/A'}</span></p>
                    </div>
                `;
                
                const actionDiv = document.createElement('div');
                actionDiv.classList.add('flex', 'space-x-4', 'mt-2', 'sm:mt-0'); // Adiciona flex para os bot√µes
                
                // Bot√£o de Excluir Usu√°rio
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = `<i class="fas fa-trash-alt text-red-500 hover:text-red-700"></i>`;
                deleteBtn.title = `Excluir usu√°rio ${user.nome}`;
                
                // Esconde o bot√£o de exclus√£o se for o pr√≥prio usu√°rio logado ou se for um master tentando excluir outro master
                if (currentUser.appDocId === user.appDocId || (currentUser.nivel === 'master' && user.nivel === 'master' && currentUser.appDocId !== user.appDocId)) {
                    deleteBtn.classList.add('hidden');
                }

                deleteBtn.addEventListener('click', async () => {
                    console.log(`[DEBUG] Tentando excluir usu√°rio. Usu√°rio logado Doc ID: ${currentUser.appDocId}, N√≠vel: ${currentUser.nivel}. Usu√°rio alvo Doc ID: ${user.appDocId}, N√≠vel: ${user.nivel}.`);

                    // 1. Verifica√ß√£o local de permiss√£o
                    let canDelete = false;
                    let reason = '';

                    if (!currentUser || !currentUser.appDocId) {
                        reason = 'Voc√™ precisa estar logado para excluir usu√°rios.';
                    } else if (currentUser.appDocId === user.appDocId) { // Auto-exclus√£o
                        canDelete = true;
                        reason = 'Auto-exclus√£o permitida.';
                    } else if (currentUser.nivel === 'master') { // Master tentando excluir outro
                        // 2. Confirma√ß√£o no Firestore (para obter o n√≠vel do usu√°rio alvo)
                        try {
                            // Acessa a cole√ß√£o 'users' diretamente
                            const targetUserDocRef = doc(db, COLLECTIONS.USERS, user.appDocId);
                            const targetUserDocSnap = await retryWithExponentialBackoff(() => getDoc(targetUserDocRef));
                            if (targetUserDocSnap.exists()) {
                                const targetUserData = targetUserDocSnap.data();
                                if (targetUserData.nivel === 'master' && user.nivel !== 'master') { 
                                    reason = 'Um usu√°rio master n√£o pode excluir outro usu√°rio master.';
                                } else {
                                    canDelete = true;
                                    reason = 'Usu√°rio master pode excluir n√£o-master.';
                                }
                            } else {
                                reason = 'Usu√°rio alvo n√£o encontrado no Firestore.';
                            }
                        } catch (fetchError) {
                            console.error("[ADD/EDIT USER] Erro ao buscar dados do usu√°rio alvo para verifica√ß√£o de exclus√£o:", fetchError);
                            showModal('Erro', 'N√£o foi poss√≠vel verificar as permiss√µes. Tente novamente.');
                            return;
                        }
                    } else {
                        reason = 'Voc√™ n√£o tem permiss√£o para excluir usu√°rios.';
                    }

                    console.log(`[DEBUG] Resultado da verifica√ß√£o local: ${canDelete}. Motivo: ${reason}`);

                    if (!canDelete) {
                        showModal('Erro de Permiss√£o', reason);
                        return;
                    }

                    showConfirmModal('Excluir Usu√°rio', `Tem certeza que deseja excluir o usu√°rio "${user.nome}"?`, async () => {
                        try {
                            // Acessa a cole√ß√£o 'users' diretamente
                            const docRef = doc(db, COLLECTIONS.USERS, user.appDocId); 
                            console.log(`[DELETE USER] Excluindo documento de usu√°rio com ID: ${user.appDocId}`);
                            await retryWithExponentialBackoff(() => deleteDoc(docRef));
                            showToast('Usu√°rio exclu√≠do com sucesso!');
                            console.log(`[DELETE USER] Usu√°rio ${user.appDocId} exclu√≠do com sucesso por ${currentUser.appDocId}.`);
                        } catch (error) {
                            console.error("[DELETE USER] Erro ao excluir usu√°rio:", error);
                            if (error.code === 'permission-denied') {
                                showModal('Erro de Permiss√£o', 'Voc√™ n√£o tem permiss√£o para excluir este usu√°rio. Verifique as regras de seguran√ßa.');
                                console.error(`[DELETE USER] Falha de permiss√£o ao excluir usu√°rio ${user.appDocId}. Usu√°rio logado Doc ID: ${currentUser.appDocId}, N√≠vel: ${currentUser.nivel}.`);
                            } else {
                                showModal('Erro', 'N√£o foi poss√≠vel excluir o usu√°rio. Tente novamente.');
                            }
                        }
                    });
                });
                actionDiv.appendChild(deleteBtn);

                // Bot√£o de Editar Usu√°rio
                const editBtn = document.createElement('button');
                editBtn.innerHTML = `<i class="fas fa-edit text-blue-500 hover:text-blue-700 ml-4"></i>`;
                editBtn.title = `Editar usu√°rio ${user.nome}`;
                editBtn.addEventListener('click', () => {
                    // Preenche o formul√°rio para edi√ß√£o
                    document.getElementById('new-user-name').value = user.nome;
                    document.getElementById('new-user-id').value = user.id;
                    document.getElementById('new-user-username').value = user.usuario;
                    document.getElementById('new-user-password').value = user.senha; // Cuidado ao preencher senhas
                    document.getElementById('new-user-level').value = user.nivel;
                    document.getElementById('add-user-form').setAttribute('data-editing-app-doc-id', user.appDocId); // Armazena o appDocId do usu√°rio a ser editado
                });
                actionDiv.appendChild(editBtn);

                userDiv.appendChild(actionDiv);
                userListContainer.appendChild(userDiv);
            });

            const pageCount = Math.ceil(filteredUsers.length / PAGINATION_LIMIT);
            for (let i = 1; i <= pageCount; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.classList.add('px-3', 'py-1', 'rounded-full', 'text-sm', 'font-medium', 'hover:bg-gray-200');
                if (i === page) {
                    pageBtn.classList.add('bg-blue-500', 'text-white', 'hover:bg-blue-600');
                } else {
                    pageBtn.classList.add('bg-gray-100', 'text-gray-700');
                }
                pageBtn.addEventListener('click', () => {
                    currentPageUsers = i;
                    renderUserList(currentPageUsers, searchTerm);
                });
                paginationContainer.appendChild(pageBtn);
            }
        };

        document.getElementById('user-search').addEventListener('input', (e) => {
            currentPageUsers = 1;
            renderUserList(currentPageUsers, e.target.value.trim()); // Trim aqui
        });

        document.getElementById('add-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const editingAppDocId = form.getAttribute('data-editing-app-doc-id');

            // Crie uma c√≥pia dos dados para evitar modifica√ß√µes diretas no objeto original
            const userData = {
                id: form['new-user-id'].value.trim(), // ID USINA
                nome: form['new-user-name'].value.trim(),
                usuario: form['new-user-username'].value.trim(),
                senha: form['new-user-password'].value.trim(),
                nivel: form['new-user-level'].value.trim(), // Trim aqui
                ativo: true,
            };

            if (!currentUser || !currentUser.appDocId) {
                showModal('Erro de Permiss√£o', 'Voc√™ precisa estar logado para adicionar/editar usu√°rios.');
                console.warn('Opera√ß√£o negada: Usu√°rio n√£o autenticado para salvar usu√°rio.');
                return;
            }

            // 1. Verifica√ß√£o local de permiss√£o para criar/atualizar
            let canSave = false;
            let reason = '';

            if (editingAppDocId) { // Atualiza√ß√£o de usu√°rio existente
                if (currentUser.appDocId === editingAppDocId) { // Auto-edi√ß√£o
                    // Permite auto-edi√ß√£o, mas impede que o usu√°rio mude seu pr√≥prio n√≠vel se n√£o for master
                    if (currentUser.nivel !== 'master' && userData.nivel !== currentUser.nivel) {
                        reason = 'Voc√™ n√£o pode alterar seu pr√≥prio n√≠vel de acesso.';
                    } else {
                        canSave = true;
                        reason = 'Auto-edi√ß√£o permitida.';
                    }
                } else if (currentUser.nivel === 'master') { // Master editando outro
                    // Master pode editar qualquer um, exceto rebaixar outro master
                    try {
                        // Acessa a cole√ß√£o 'users' diretamente
                        const targetUserDocRef = doc(db, COLLECTIONS.USERS, editingAppDocId);
                        const targetUserDocSnap = await retryWithExponentialBackoff(() => getDoc(targetUserDocRef));
                        if (targetUserDocSnap.exists()) {
                            const targetUserData = targetUserDocSnap.data();
                            if (targetUserData.nivel === 'master' && userData.nivel !== 'master') {
                                reason = 'Um usu√°rio master n√£o pode rebaixar outro usu√°rio master.';
                            } else {
                                canSave = true;
                                reason = 'Master editando outro usu√°rio permitido.';
                            }
                        } else {
                            reason = 'Usu√°rio alvo n√£o encontrado para edi√ß√£o.';
                        }
                    } catch (fetchError) {
                        console.error("[ADD/EDIT USER] Erro ao buscar dados do usu√°rio alvo para verifica√ß√£o de edi√ß√£o:", fetchError);
                        showModal('Erro', 'N√£o foi poss√≠vel verificar as permiss√µes. Tente novamente.');
                        return;
                    }
                } else {
                    reason = 'Voc√™ n√£o tem permiss√£o para editar outros usu√°rios.';
                }
            } else { // Cria√ß√£o de novo usu√°rio
                if (currentUser.nivel === 'master') {
                    // Verifica por "usuario" ou "id" duplicados antes de criar
                    const qUser = query(collection(db, COLLECTIONS.USERS), where("usuario", "==", userData.usuario));
                    const userSnapshot = await retryWithExponentialBackoff(() => getDocs(qUser));

                    const qId = query(collection(db, COLLECTIONS.USERS), where("id", "==", userData.id));
                    const idSnapshot = await retryWithExponentialBackoff(() => getDocs(qId));

                    if (!userSnapshot.empty) {
                        showModal('Erro', 'J√° existe um usu√°rio com este "Usu√°rio (Login)". Por favor, use um diferente.');
                        return;
                    }
                    if (!idSnapshot.empty) {
                        showModal('Erro', 'J√° existe um usu√°rio com este "ID USINA". Por favor, use um diferente.');
                        return;
                    }
                    canSave = true;
                    reason = 'Master pode criar novos usu√°rios.';
                } else {
                    reason = 'Voc√™ n√£o tem permiss√£o para criar novos usu√°rios.';
                }
            }
            
            console.log(`[ADD/EDIT USER] Resultado da verifica√ß√£o local para salvar usu√°rio: ${canSave}. Motivo: ${reason}`);

            if (!canSave) {
                showModal('Erro de Permiss√£o', reason);
                return;
            }
            
            try {
                let docRef;
                let message;

                if (editingAppDocId) {
                    // Se estiver editando, usa o ID do documento existente
                    docRef = doc(db, COLLECTIONS.USERS, editingAppDocId);
                    message = 'Usu√°rio atualizado com sucesso!';
                    form.removeAttribute('data-editing-app-doc-id');
                    // N√£o altera actualFirebaseAuthUid ao editar, a menos que seja explicitamente um re-link
                    // O valor existente em 'actualFirebaseAuthUid' deve ser preservado.
                    // Para garantir que ele exista no objeto, podemos fazer um merge.
                    await retryWithExponentialBackoff(() => setDoc(docRef, userData, { merge: true }));
                } else {
                    // Para novos usu√°rios, gera um UUID aleat√≥rio como ID do documento no Firestore
                    const newAppDocId = crypto.randomUUID();
                    docRef = doc(db, COLLECTIONS.USERS, newAppDocId);
                    userData.criadoEm = serverTimestamp(); // Adiciona criadoEm apenas para novos usu√°rios
                    userData.actualFirebaseAuthUid = null; // Novos usu√°rios come√ßam sem v√≠nculo Firebase Auth UID
                    await retryWithExponentialBackoff(() => setDoc(docRef, userData)); // Usar setDoc sem merge para novos
                    message = 'Novo usu√°rio salvo com sucesso!';
                }
                
                console.log("[ADD/EDIT USER] Tentando salvar usu√°rio no Firestore. Caminho:", docRef.path, "Dados:", userData); 
                showToast(message);
                form.reset();
            } catch (error) {
                console.error("[ADD/EDIT USER] Erro ao salvar usu√°rio no Firestore:", error);
                if (error.code === 'permission-denied') {
                    showModal('Erro de Permiss√£o', 'Voc√™ n√£o tem permiss√£o para salvar este usu√°rio. Verifique as regras de seguran√ßa.');
                } else {
                    showModal('Erro de Grava√ß√£o', 'N√£o foi poss√≠vel salvar o usu√°rio no banco de dados. Verifique o console para mais detalhes.');
                }
            }
        });

        // --- Importa√ß√£o em Massa de Usu√°rios ---

        document.getElementById('import-xlsx-btn').addEventListener('click', () => {
            if (!currentUser || currentUser.nivel !== 'master') {
                showModal('Erro de Permiss√£o', 'Voc√™ n√£o tem permiss√£o para importar usu√°rios.');
                console.warn(`Opera√ß√£o negada: Usu√°rio ${currentUser ? currentUser.appDocId : 'N/A'} (${currentUser ? currentUser.nivel : 'N/A'}) tentou importar XLSX sem permiss√£o.`);
                return;
            }
            document.getElementById('upload-xlsx-input').click();
        });

        document.getElementById('upload-xlsx-input').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet);

                        let successCount = 0;
                        let errorCount = 0;
                        console.log(`[IMPORT XLSX] Iniciando importa√ß√£o de ${json.length} linhas.`);

                        for (const row of json) {
                            const newAppDocId = crypto.randomUUID(); // Gerar UUID para cada novo documento

                            const userData = {
                                nome: String(row.nome || '').trim(),
                                usuario: String(row.usuario || '').trim(),
                                senha: String(row.senha || '').trim(),
                                nivel: String(row.nivelAcesso || '').trim(),
                                id: String(row.id || '').trim(), // ID USINA
                                ativo: true, 
                                criadoEm: serverTimestamp(),
                                actualFirebaseAuthUid: null, // Inicialmente null para usu√°rios importados
                            };

                            if (!userData.nome || !userData.usuario || !userData.senha || !userData.nivel || !userData.id) {
                                console.warn("[IMPORT XLSX] Linha ignorada devido a dados incompletos:", row);
                                errorCount++;
                                continue;
                            }

                            try {
                                // Verificar duplicidade de 'usuario' ou 'id' antes de adicionar
                                const qUser = query(collection(db, COLLECTIONS.USERS), where("usuario", "==", userData.usuario));
                                const userSnapshot = await retryWithExponentialBackoff(() => getDocs(qUser));
                                const qId = query(collection(db, COLLECTIONS.USERS), where("id", "==", userData.id));
                                const idSnapshot = await retryWithExponentialBackoff(() => getDocs(qId));

                                if (!userSnapshot.empty) {
                                    console.warn(`[IMPORT XLSX] Usu√°rio '${userData.usuario}' j√° existe. Linha ignorada.`);
                                    errorCount++;
                                    continue;
                                }
                                if (!idSnapshot.empty) {
                                    console.warn(`[IMPORT XLSX] ID USINA '${userData.id}' j√° existe. Linha ignorada.`);
                                    errorCount++;
                                    continue;
                                }

                                // Acessa a cole√ß√£o 'users' diretamente, usando o UUID como ID do documento
                                const docRef = doc(db, COLLECTIONS.USERS, newAppDocId); 
                                console.log(`[IMPORT XLSX] Tentando salvar usu√°rio importado: ${userData.usuario} com ID: ${newAppDocId}`);
                                await retryWithExponentialBackoff(() => setDoc(docRef, userData));
                                successCount++;
                                console.log(`[IMPORT XLSX] Usu√°rio importado salvo com sucesso: ${userData.usuario}`);
                            } catch (error) {
                                console.error("[IMPORT XLSX] Erro ao salvar usu√°rio da planilha:", userData, error);
                                errorCount++;
                            }
                        }
                        showModal('Importa√ß√£o Conclu√≠da', `Importa√ß√£o de XLSX finalizada. Sucesso: ${successCount}, Erros: ${errorCount}.`);
                        console.log(`[IMPORT XLSX] Importa√ß√£o de XLSX finalizada. Sucesso: ${successCount}, Erros: ${errorCount}.`);
                    } catch (error) {
                        console.error("[IMPORT XLSX] Erro ao ler arquivo XLSX:", error);
                        showModal('Erro de Importa√ß√£o', 'N√£o foi poss√≠vel ler o arquivo XLSX. Verifique o formato.');
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        });

        document.getElementById('import-csv-btn').addEventListener('click', () => {
            if (!currentUser || currentUser.nivel !== 'master') {
                showModal('Erro de Permiss√£o', 'Voc√™ n√£o tem permiss√£o para importar usu√°rios.');
                console.warn(`Opera√ß√£o negada: Usu√°rio ${currentUser ? currentUser.appDocId : 'N/A'} (${currentUser ? currentUser.nivel : 'N/A'}) tentou importar CSV sem permiss√£o.`);
                return;
            }
            document.getElementById('upload-csv-input').click();
        });

        document.getElementById('upload-csv-input').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const csvData = e.target.result;
                        const lines = csvData.split('\n').filter(line => line.trim() !== '');
                        if (lines.length === 0) {
                            showModal('Aviso', 'O arquivo CSV est√° vazio.');
                            return;
                        }

                        const headers = lines[0].split(',').map(h => h.trim());
                        const expectedHeaders = ['nome', 'usuario', 'senha', 'nivelAcesso', 'id'];
                        
                        const missingHeaders = expectedHeaders.filter(header => !headers.includes(header));
                        if (missingHeaders.length > 0) {
                            showModal('Erro de Formato', `Faltam as seguintes colunas no CSV: ${missingHeaders.join(', ')}. As colunas esperadas s√£o: ${expectedHeaders.join(', ')}.`);
                            return;
                        }

                        let successCount = 0;
                        let errorCount = 0;
                        console.log(`[IMPORT CSV] Iniciando importa√ß√£o de ${lines.length - 1} linhas.`);

                        for (let i = 1; i < lines.length; i++) {
                            const values = lines[i].split(',').map(v => v.trim());
                            const rowData = {};
                            headers.forEach((header, index) => {
                                rowData[header] = values[index];
                            });

                            const newAppDocId = crypto.randomUUID(); // Gerar UUID para cada novo documento

                            const userData = {
                                nome: String(rowData.nome || '').trim(),
                                usuario: String(rowData.usuario || '').trim(),
                                senha: String(rowData.senha || '').trim(),
                                nivel: String(rowData.nivelAcesso || '').trim(),
                                id: String(rowData.id || '').trim(), // ID USINA
                                ativo: true, 
                                criadoEm: serverTimestamp(),
                                actualFirebaseAuthUid: null, // Inicialmente null
                            };

                            if (!userData.nome || !userData.usuario || !userData.senha || !userData.nivel || !userData.id) {
                                console.warn("[IMPORT CSV] Linha ignorada devido a dados incompletos:", rowData);
                                errorCount++;
                                continue;
                            }

                            try {
                                // Verificar duplicidade de 'usuario' ou 'id' antes de adicionar
                                const qUser = query(collection(db, COLLECTIONS.USERS), where("usuario", "==", userData.usuario));
                                const userSnapshot = await retryWithExponentialBackoff(() => getDocs(qUser));
                                const qId = query(collection(db, COLLECTIONS.USERS), where("id", "==", userData.id));
                                const idSnapshot = await retryWithExponentialBackoff(() => getDocs(qId));

                                if (!userSnapshot.empty) {
                                    console.warn(`[IMPORT CSV] Usu√°rio '${userData.usuario}' j√° existe. Linha ignorada.`);
                                    errorCount++;
                                    continue;
                                }
                                if (!idSnapshot.empty) {
                                    console.warn(`[IMPORT CSV] ID USINA '${userData.id}' j√° existe. Linha ignorada.`);
                                    errorCount++;
                                    continue;
                                }

                                // Acessa a cole√ß√£o 'users' diretamente, usando o UUID como ID do documento
                                const docRef = doc(db, COLLECTIONS.USERS, newAppDocId); 
                                console.log(`[IMPORT CSV] Tentando salvar usu√°rio importado: ${userData.usuario} com ID: ${newAppDocId}`);
                                await retryWithExponentialBackoff(() => setDoc(docRef, userData));
                                successCount++;
                                console.log(`[IMPORT CSV] Usu√°rio importado salvo com sucesso: ${userData.usuario}`);
                            } catch (error) {
                                console.error("[IMPORT CSV] Erro ao salvar usu√°rio do CSV:", userData, error);
                                errorCount++;
                            }
                        }
                        showModal('Importa√ß√£o Conclu√≠da', `Importa√ß√£o de CSV finalizada. Sucesso: ${successCount}, Erros: ${errorCount}.`);
                        console.log(`[IMPORT CSV] Importa√ß√£o de CSV finalizada. Sucesso: ${successCount}, Erros: ${errorCount}.`);
                    } catch (error) {
                        console.error("[IMPORT CSV] Erro ao ler arquivo CSV:", error);
                        showModal('Erro de Importa√ß√£o', 'N√£o foi poss√≠vel ler o arquivo CSV. Verifique o formato.');
                    }
                };
                reader.readAsText(file);
            }
        });


        // Modal de Alterar Senha
        document.getElementById('change-password-btn').addEventListener('click', () => {
            document.getElementById('change-password-modal').style.display = 'flex';
            document.getElementById('change-password-modal-form').reset();
        });

        document.getElementById('change-password-modal-cancel-btn').addEventListener('click', hideModal);

        document.getElementById('change-password-modal-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const currentPassword = form['current-password-modal'].value.trim();
            const newPassword = form['new-password-modal'].value.trim();
            const confirmNewPassword = form['confirm-new-password-modal'].value.trim();

            if (newPassword !== confirmNewPassword) {
                showModal('Erro', 'A nova senha e a confirma√ß√£o de senha n√£o coincidem.');
                return;
            }

            if (!currentUser || !currentUser.appDocId) {
                showModal('Erro', 'Usu√°rio n√£o autenticado. Fa√ßa login novamente.');
                return;
            }

            try {
                // Acessa a cole√ß√£o 'users' diretamente
                const userDocRef = doc(db, COLLECTIONS.USERS, currentUser.appDocId); // Usa appDocId
                const userDocSnap = await retryWithExponentialBackoff(() => getDoc(userDocRef));
                const userData = userDocSnap.data();

                if (userData.senha !== currentPassword) {
                    showModal('Erro', 'A senha atual est√° incorreta.');
                    return;
                }

                console.log(`[CHANGE PASSWORD] Alterando senha para usu√°rio ${currentUser.usuario} (Doc ID: ${currentUser.appDocId}).`);
                await retryWithExponentialBackoff(() => updateDoc(userDocRef, { senha: newPassword }));
                showToast('Senha alterada com sucesso!', 'success');
                hideModal();
                console.log(`[CHANGE PASSWORD] Senha alterada com sucesso para usu√°rio ${currentUser.usuario}.`);
            } catch (error) {
                console.error("[CHANGE PASSWORD] Erro ao alterar senha:", error);
                if (error.code === 'permission-denied') {
                    showModal('Erro de Permiss√£o', 'Voc√™ n√£o tem permiss√£o para alterar sua senha.');
                } else {
                    showModal('Erro', 'N√£o foi poss√≠vel alterar a senha. Tente novamente.');
                }
            }
        });

        togglePasswordVisibility('#current-password-modal', '#toggle-current-password-modal');
        togglePasswordVisibility('#new-password-modal', '#toggle-new-password-modal');
        togglePasswordVisibility('#confirm-new-password-modal', '#toggle-confirm-new-password-modal');


        // --- Event Listeners Globais ---
        document.getElementById('modal-close-btn').addEventListener('click', hideModal);
        document.getElementById('confirm-modal-cancel-btn').addEventListener('click', hideModal);
        
        document.getElementById('aplicador-tab').addEventListener('click', () => switchTab('aplicador'));
        document.getElementById('lider-tab').addEventListener('click', () => switchTab('lider'));
        document.getElementById('pcma-tab').addEventListener('click', () => switchTab('pcma'));
        document.getElementById('realizados-tab').addEventListener('click', () => { switchTab('realizados'); listenForAppliedChecklists(); });
        document.getElementById('novos-tab').addEventListener('click', () => switchTab('novos'));
        document.getElementById('cadastro-tab').addEventListener('click', () => switchTab('cadastro'));
        
        // --- Fun√ß√µes de Impress√£o e Exporta√ß√£o ---

        // Reusable function to generate PDF blob
        const generatePdfBlob = async (reportContentElement, frotaNumber) => {
            try {
                const canvas = await html2canvas(reportContentElement, { scale: 2 });
                const imgData = canvas.toDataURL('image/png');

                const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
                const imgWidth = 210;
                const pageHeight = 297;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                // Return the PDF as a Blob
                return pdf.output('blob');

            } catch (error) {
                console.error("Erro ao gerar PDF:", error);
                throw new Error('N√£o foi poss√≠vel gerar o PDF.');
            }
        };

        document.getElementById('export-pdf-btn').addEventListener('click', async () => {
            const reportContent = document.getElementById('report-content');
            const frotaNumber = document.getElementById('report-modal').getAttribute('data-frota') || '000000';
            try {
                const pdfBlob = await generatePdfBlob(reportContent, frotaNumber);
                const a = document.createElement('a');
                a.href = URL.createObjectURL(pdfBlob);
                a.download = `relatorio-checklist - Frota -${frotaNumber}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href); // Clean up
                showToast('Exportado para PDF com sucesso!', 'success');
                console.log(`Relat√≥rio PDF exportado para Frota: ${frotaNumber}`);
            } catch (error) {
                showModal('Erro', error.message);
            }
        });

        document.getElementById('share-report-btn').addEventListener('click', async () => {
            const checklist = allAppliedChecklists.find(c => c.id === document.getElementById('report-modal').getAttribute('data-id'));
            const reportContent = document.getElementById('report-content');
            const frotaNumber = document.getElementById('report-modal').getAttribute('data-frota') || '000000';

            if (!checklist) {
                showModal('Erro', 'Checklist n√£o encontrado para compartilhamento.');
                return;
            }

            try {
                const pdfBlob = await generatePdfBlob(reportContent, frotaNumber);
                const pdfFile = new File([pdfBlob], `relatorio-checklist - Frota -${frotaNumber}.pdf`, { type: 'application/pdf' });

                if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                    console.log(`Tentando compartilhar PDF para Frota: ${frotaNumber} via Web Share API.`);
                    await navigator.share({
                        files: [pdfFile],
                        title: `Relat√≥rio InspCampo - Frota ${frotaNumber}`,
                        text: `Relat√≥rio de Checklist para Frota ${frotaNumber} gerado em InspCampo.`,
                    });
                    showToast('Relat√≥rio PDF compartilhado com sucesso!', 'success');
                    console.log(`Relat√≥rio PDF compartilhado com sucesso para Frota: ${frotaNumber}.`);
                } else {
                    // Fallback: download PDF and inform user
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(pdfBlob);
                    a.download = `relatorio-checklist - Frota -${frotaNumber}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(a.href);
                    showModal('Compartilhar Relat√≥rio', 'Seu navegador n√£o suporta o compartilhamento direto de arquivos. O relat√≥rio foi baixado para o seu dispositivo.');
                    console.warn(`Compartilhamento Web Share API n√£o suportado. PDF baixado para Frota: ${frotaNumber}.`);
                }
            } catch (error) {
                console.error('Erro ao compartilhar PDF:', error);
                if (error.name === 'AbortError') {
                    showToast('Compartilhamento cancelado.', 'error');
                    console.log('Compartilhamento cancelado pelo usu√°rio.');
                } else {
                    showModal('Erro ao Compartilhar', 'N√£o foi poss√≠vel compartilhar o relat√≥rio PDF. ' + error.message + ' O relat√≥rio foi baixado para o seu dispositivo.');
                    // Fallback: download PDF if sharing failed
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(pdfBlob);
                    a.download = `relatorio-checklist - Frota -${frotaNumber}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(a.href);
                    console.error(`Falha no compartilhamento de PDF para Frota: ${frotaNumber}. PDF baixado como fallback.`);
                }
            }
        });

        document.getElementById('export-xlsx-btn').addEventListener('click', () => {
            const checklist = allAppliedChecklists.find(c => c.id === document.getElementById('report-modal').getAttribute('data-id'));
            const frotaNumber = document.getElementById('report-modal').getAttribute('data-frota') || '000000';
            if (!checklist) {
                showModal('Erro', 'Checklist n√£o encontrado para exporta√ß√£o.');
                return;
            }
            
            const data = [];
            data.push(['T√≠tulo', checklist.checklist.title]);
            data.push(['Frota', checklist.frota]);
            data.push(['N¬∫ OS', checklist.os]);
            data.push(['Aplicador Nome', checklist.aplicador.nome]);
            data.push(['Aplicador ID', checklist.aplicador.id]);
            data.push(['Mec√¢nico', checklist.mecanico]);
            data.push(['Data', new Date(checklist.criadoEm).toLocaleDateString('pt-BR')]);
            data.push(['Hora Inicial', checklist.horaInicial]);
            data.push(['Hora Final', checklist.horaFinal]);
            data.push(['Status L√≠der', checklist.status.lider]);
            data.push(['Status PCMA', checklist.status.pcma]);
            data.push([]);
            data.push(['Se√ß√£o', 'Item', 'Resposta', 'Observa√ß√£o']);
            
            checklist.checklist.sections.forEach(section => {
                section.items.forEach(item => {
                    let resposta = '';
                    let observacao = item.observacao || '';
                    if (item.status) {
                        resposta = item.status.toUpperCase();
                    } else if (item.value) {
                        resposta = item.value;
                    }
                    data.push([section.sectionTitle, item.itemText, resposta, observacao]);
                });
            });

            try {
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Relat√≥rio");
                XLSX.writeFile(wb, `relatorio-checklist - Frota -${frotaNumber}.xlsx`);
                showToast('Exportado para XLSX!', 'success');
                console.log(`Relat√≥rio XLSX exportado para Frota: ${frotaNumber}`);
            } catch (error) {
                console.error("Erro ao exportar XLSX:", error);
                showModal('Erro', 'N√£o foi poss√≠vel exportar o relat√≥rio para XLSX. Por favor, tente novamente.');
            }
        });

        // --- Fun√ß√µes de Avatar ---
        document.getElementById('user-avatar').addEventListener('click', () => {
            document.getElementById('avatar-modal').style.display = 'flex';
        });

        document.getElementById('avatar-modal-close-btn').addEventListener('click', hideModal);

        document.getElementById('take-photo-btn').addEventListener('click', () => {
            document.getElementById('upload-photo-input').click();
        });

        document.getElementById('choose-photo-btn').addEventListener('click', () => {
            document.getElementById('upload-photo-input').click();
        });

        document.getElementById('upload-photo-input').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const avatarImg = document.createElement('img');
                    avatarImg.src = e.target.result;
                    const userAvatarDiv = document.getElementById('user-avatar');
                    userAvatarDiv.innerHTML = '';
                    userAvatarDiv.appendChild(avatarImg);
                    localStorage.setItem(`avatar-${currentUser.appDocId}`, e.target.result); // Usa appDocId para avatar
                    hideModal();
                    showToast('Avatar atualizado com sucesso!', 'success');
                    console.log(`Avatar atualizado para usu√°rio: ${currentUser.appDocId}`);
                };
                reader.readAsDataURL(file);
            }
        });


        // --- Inicializa√ß√£o ---
        window.onload = function() {
            setTimeout(() => {
                initFirebase();
                togglePasswordVisibility('#password', '#toggle-password');
                togglePasswordVisibility('#new-user-password', '#toggle-new-user-password');
                togglePasswordVisibility('#current-password-modal', '#toggle-current-password-modal');
                togglePasswordVisibility('#new-password-modal', '#toggle-new-password-modal');
                togglePasswordVisibility('#confirm-new-password-modal', '#toggle-confirm-new-password-modal');
                
                const passwordInput = document.getElementById('password');
                const capsLockWarning = document.getElementById('caps-lock-warning');
                if (passwordInput && capsLockWarning) {
                    passwordInput.addEventListener('keyup', (e) => {
                        if (e.getModifierState('CapsLock')) {
                            capsLockWarning.classList.remove('hidden');
                        } else {
                            capsLockWarning.classList.add('hidden');
                        }
                    });
                }

                // Adiciona listeners para status online/offline
                window.addEventListener('online', checkOnlineStatus);
                window.addEventListener('offline', checkOnlineStatus);
                checkOnlineStatus(); // Verifica o status inicial

                if ('standalone' in navigator && navigator.standalone || window.matchMedia('(display-mode: standalone)').matches) {
                    // J√° est√° em modo PWA, n√£o faz nada
                } else if (window.matchMedia('(max-width: 768px)').matches) {
                    setTimeout(() => {
                        // showModal('Adicionar √† tela inicial?', 'Deseja adicionar um √≠cone deste aplicativo √† sua tela inicial para acesso r√°pido?');
                    }, 3000);
                }
            }, 100);
        };
    </script>
</body>
</html>

